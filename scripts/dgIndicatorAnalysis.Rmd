---
title: "Analysis of NLA17 Dissolved Gas Indicator"
authors: "J. Beaulieu, R. Martin, and M. McManus"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: yes
    depth: 2
    number_sections: true
    code_folding:  hide
editor_options: 
  chunk_output_type: console
---

```{r results='hide', message=FALSE, warning=FALSE}
# load libraries
library(sf) # spatial data
library(gstat) # lagged scatterplot, variogram
#library(spdplyr) # apply dplyr verbs to sp objects.  gstat functions require sp objects
library(tidyverse) # dplyr, ggplot

# Identify local path for each user
localPath <- Sys.getenv("USERPROFILE")

# Define helper functions
# standardized formatting for column names
toEPA <- function(X1){
  names(X1) = tolower(names(X1))
  names(X1) = gsub(pattern = c("\\(| |#|)|/|-|\\+|:|_"), replacement = ".", x = names(X1))
  X1
}
```


# Background
During the 2017 National Lakes Assesment, duplicate dissolved gas samples were collected at a depth of ~0.1m at the index site at each waterbody.  Gas samples were analyzed for CO~2~, CH~4~, and N~2~O concentration via gas chromatography and $\delta^{13}CO_{2}$ and $\delta^{13}CH_{4}$ via cavity ring-down spectroscopy.  The following analysis pertains to the concentration data.


# Data


The dissolved gas data were currated the 'NLA' dissolved gas project in RStudio.  The code can be found at a private github repository (https://github.com/USEPA/NLA).  After aggregating across duplicate samples, the data were written to nla17gasDataAggregated_2019-10-25.txt.  A copy of this data file is stored in documents library associated with the 'ORD NLA17 Dissolved Gas' Private Group on SharePoint (https://usepa.sharepoint.com/sites/ORD_NLA17_Dissolved_Gas).  When synced to a local computer, the documents library can be read directly with R, after identifying the local directory path.
## Getting data and filtering

The dissolved gas data were currated in the 'NLA' dissolved gas project in RStudio.  The code can be found at a private github repository (https://github.com/USEPA/NLA).  After aggregating across duplicate samples, the data were written to nla17gasDataAggregated_2019-10-25.txt.  A copy of this data file is stored in the documents library associated with the 'ORD NLA17 Dissolved Gas' Private Group on SharePoint (https://usepa.sharepoint.com/sites/ORD_NLA17_Dissolved_Gas).  When synced to a local computer, the documents library can be read directly with R.


```{r}
# Read data file
dg <- read.table(file = paste0(localPath, 
                               "/Environmental Protection Agency (EPA)/",
                               "ORD NLA17 Dissolved Gas - Documents/",
                           "inputData/nla17gasDataAggregated_2019-11-12.txt"), 
                 header = TRUE, sep = "\t", as.is = TRUE) %>%
  # unit conversion
  mutate(dissolved.ch4 = dissolved.ch4 * 1000000, # mol/L -> umol/L
         dissolved.co2 = dissolved.co2 * 1000000, # mol/L -> umol/L,
         dissolved.n20 = dissolved.n2o * 1000000000, # mol/L -> nmol/L
         # add source/sink column
         co2.src.snk = ifelse(co2.sat.ratio > 1, "source", "sink"),
         ch4.src.snk = ifelse(ch4.sat.ratio > 1, "source", "sink"),
         n2o.src.snk = ifelse(n2o.sat.ratio > 1, "source", "sink"))

```
Concentrations of CO~2~, CH~4~, and N~2~O in ambient air over the waterbodies were measured and used in the dissolved gas concentrations.  These data are not needed in subsequent analysis and will be removed from the dataframe.
```{r}
dg <- dg %>% filter(sample.source == "DG") # select dissolved gas 'DG' samples
```
The dataframe also contains observations from site in Alaska.  These sites were not an official part of the NLA and will not be included in this analysis.
```{r}
dg <- dg %>% filter(!(grepl("AK", site.id))) # exlclude alaska
```



The data file contains `r dg %>% distinct(site.id, visit.no) %>% summarize(n = n()) %>% pull()` unique sampling trips defined by unique combinations of 'site.id' and 'visit.no'.  There were `r dg %>% distinct(site.id) %>% summarize(n = n()) %>% pull()` waterbodies sampled, `r dg %>% filter(visit.no == 2) %>% summarize(n = n()) %>% pull()` of which were sampled twice. The primary response variables are the concentrations of CO~2~, CH~4~, and N~2~O dissolved in the surface water of each waterbody.  Concentration is expressed in both mass based units (umol/L, nmol/L: dissolved.co2, dissolved.ch4, dissolved.n2o) and as a saturation ratio (co2.sat.ratio, ch4.sat.ratio, n2o.sat.ratio).  Saturation ratio is defined as the ratio of the measured concentration to that expected if the waterbody were in equilibrium with the atmosphere.  A value of 1 indicates equilibrium, values < 1 indicate undersaturation and values > 1 indicate supersaturation.  Undersaturated waterbodies function as a sink for the atmospheric gas whereas supersaturated waterbodies function as a source.


```{r}
# are these the main response variables we'll be looking at?
dg %>% select(dissolved.co2, dissolved.ch4, dissolved.n2o, co2.sat.ratio, ch4.sat.ratio, n2o.sat.ratio) %>%
  {summary(.)}
```


#  Exploratory spatial analysis
## Population estimates by ecoregion
The survey design allows for population estimates of central tendency and variance by ecoregion (and other subpopulations), which can provide insight into spatial patterning.  There is broad overlap in mean +/- 95% CI estimates for dissolved CH4 concentation.  The Northern Plains, Temperate Plains, and Western Mountains have low dissolved CO2 concentration.  

```{r, fig.cap= "Fig. caption: Mean +/- 95% CI for the dissolved gas concentration indicator"}
# Read population estimates provided by Steve Paulsen (11/7/2019)
pop <- read.csv(file = paste0(localPath, 
                              "/Environmental Protection Agency (EPA)/",
                              "ORD NLA17 Dissolved Gas - Documents/",
                              "inputData/populationEstimates/",
                              "NLA_2017_Percentile_Estimates_20191107.csv"),
                as.is = TRUE) %>%
  toEPA()  # enforce formatting convention

# Convert units for dissolved gas concentration indicator
pop <- pop %>%
  mutate(estimate = ifelse(grepl("dissolved.c", indicator, ignore.case = TRUE), # dissolved.co2 or dissolved.ch4
                            estimate * 1000000, # mol/L -> umol/L for co2 and ch4
                           ifelse(grepl("dissolved.n", indicator, ignore.case = TRUE), # dissolved.n2o
                            estimate * 1000000000, # mol/L -> nmol/L for n2o
                            estimate)), # all others
         lcb95pct = ifelse(grepl("dissolved.c", indicator, ignore.case = TRUE), # dissolved.co2 or dissolved.ch4
                            lcb95pct * 1000000, # mol/L -> umol/L for co2 and ch4
                           ifelse(grepl("dissolved.n", indicator, ignore.case = TRUE), # dissolved.n2o
                            lcb95pct * 1000000000, # mol/L -> nmol/L for n2o
                            lcb95pct)), # all others
         ucb95pct = ifelse(grepl("dissolved.c", indicator, ignore.case = TRUE), # dissolved.co2 or dissolved.ch4
                            ucb95pct * 1000000, # mol/L -> umol/L for co2 and ch4
                           ifelse(grepl("dissolved.n", indicator, ignore.case = TRUE), # dissolved.n2o
                            ucb95pct * 1000000000, # mol/L -> nmol/L for n2o
                            ucb95pct))) # all others


# extract population estimates for ecoregion and nation
pop.eco <- pop %>% 
  filter(type %in% c("AG_ECO9_NM", "National"), # extract estimates for ecoregion and nation
         statistic == "50Pct") # extract mean estimate

# extract dissolved gas indicator, order by dissolved CH4
pop.eco.diss <- pop.eco %>%
  filter(grepl("dissolved", indicator, ignore.case = TRUE)) %>%
  mutate(subpopulation = factor(subpopulation, 
                             levels = filter(pop.eco, indicator == "DISSOLVED_CH4", subpopulation != "National") %>%
                               arrange(estimate) %>%
                               select(subpopulation) %>%
                               pull() %>%
                               c("National", .)))
  
# look at dissolved concentration indicator
ggplot(pop.eco.diss, aes(estimate, subpopulation)) +
  geom_point() +
  geom_errorbarh(aes(xmax = ucb95pct, xmin = lcb95pct)) +
  facet_wrap(~indicator, scales = "free_x") +
  theme(axis.title = element_blank())

  
```


```{r}
# To enable spatial analysis of the data, the dataframe will be converted to a 'simple features' (sf) object.
# Define coordinates
coords <- data.frame(longitude = dg$map.lon.dd, latitude = dg$map.lat.dd)

dg.sf <- st_as_sf(dg, coords = c("map.lon.dd", "map.lat.dd"), 
                  crs = 4269) %>% # standard for lat/lon
  st_transform(5070) # project to CONUS ALBERS for plotting



# read in ecoregion polygons
ecoR <- st_read(dsn = paste0(localPath, 
                             "/Environmental Protection Agency (EPA)/",
                             "ORD NLA17 Dissolved Gas - Documents/inputData"),
                layer = "Aggr_Ecoregions9_2015")



# "Temperate" is misspelled.
ecoR <- ecoR %>% 
  mutate(WSA9_NAME = as.character(WSA9_NAME), # conv to char
         WSA9_NAME = ifelse(WSA9_NAME == "Temporate Plains",
                            "Temperate Plains", # correct sp
                            WSA9_NAME),
         WSA9_NAME = as.factor(WSA9_NAME)) # back to factor

# Check CRS
st_crs(ecoR) # no EPSG code
ecoR <- st_transform(ecoR, 5070) # convert to CONUS Albers
st_crs(ecoR) # 5070
```


# Bubble plots
Bubble plots can be used to visualize patterns in geospatial data.  In the plots below, bubble size reflects the gas concentration and color reflects saturation status (i.e. source or sink).  The code immediately below converts the dataframe to a spatial object and reads in the ecoregion ploygons.  The first bubble plot below is of dissolved CO2 which seems to show a pattern of higher concentrations along the eastern seaboard.
```{r}
# CO2 Bubble plots

ggplot() +
  geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
  geom_sf(data = dg.sf, aes(size = dissolved.co2, color = co2.src.snk), 
          show.legend = "point") + # improve legend
  ggtitle("Dissolved CO2 (uM)") +
  scale_color_manual(values = c("white", "black"), name = "source/sink") +
  scale_size(name = "dissolved CO2 (uM)",
             range = c(0.1, 5), # custom size range
             breaks = c(10, 100, 300, 600)) # custom breaks
```

Spatial patterns in dissolved CH4 are not apparent, although all but two sites are supersaturated. 

```{r}
ggplot() +
  geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
  geom_sf(data = dg.sf, aes(size = dissolved.ch4, color = ch4.src.snk), 
          show.legend = "point") +
  ggtitle("Dissolved CH4 (uM)") +
  scale_color_manual(values = c("white", "black"), name = "source/sink") +
  scale_size(name = "dissolved CH4 (uM)",
             range = c(0.1, 10), # custom size range
             breaks = c(0.1, 1, 10, 50, 100)) # custom breaks
```

The prevalance of undersaturated dissolved N2O concentrations is an important finding.  The IPCC assumes surface waters are an important source of N2O to the atmosphere.   Webb et al. recently published a paper in PNAS reporting that 70 out of 101 reservoirs sampled in Saskatchewan were N2O sinks.  This paper made quite a splash.  In our study, `r sum(dg$n2o.src.snk == "sink")` out of `r sum(!is.na(dg$dissolved.n2o))` sampled waterbodies were an N2O sink. It is somewhat interesting to note that the some of the highest concentrations were observed in Indiana/Ohio, where I conducted much of my dissertation research on aquatic N2O emissions.

```{r}
ggplot() +
  geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
  geom_sf(data = dg.sf, aes(size = dissolved.n2o, color = n2o.src.snk),
          show.legend = "point") +
  ggtitle("Dissolved N2O (nM)") +
  scale_color_manual(values = c("white", "black"), name = "source/sink") +
  scale_size(name = "dissolved N2O (nM)",
             range = c(0.1, 10), # custom size range
             breaks = c(1, 10, 25, 50, 100)) # custom breaks
```

We can also look at population estimates of N2O saturation ratio by ecoregion.  Wow, the mean N2O saturation is less than one for all ecoregions and the nation!  95% CI overlap one in only 3 levels of the stratification.  This is pretty big news. 
```{r}

# extract saturation indicator, order by n2o
pop.eco.sat <- pop.eco %>%
  filter(grepl("sat", indicator, ignore.case = TRUE)) %>%
  mutate(subpopulation = factor(subpopulation, 
                             levels = filter(pop.eco, indicator == "N2O_SAT_RATIO", subpopulation != "National") %>%
                               arrange(estimate) %>%
                               select(subpopulation) %>%
                               pull() %>%
                               c("National", .)))
  
# look at dissolved concentration indicator
ggplot(pop.eco.sat, aes(estimate, subpopulation)) +
  geom_point() +
  geom_errorbarh(aes(xmax = ucb95pct, xmin = lcb95pct)) +
  facet_wrap(~indicator, scales = "free_x") +
  theme(axis.title = element_blank())

```


## Summarizing distances
Getting distances between sites overall and by ecoregion to help set distances for lagged scatterplots.  First, Worked out steps on a sample of NLA sites.  Could only get parts of Anna Springsteen's code to work.
```{r, distances}
names(dg.sf)
head(dg.sf$WSA9_NAME)
distinct(dg.sf, WSA9_NAME) # is distinct on sf object only returning first 10 distinct coordinates, and not WSA9_NAME
distinct.Spatial(dg.sf, WSA9_NAME) # this doesn't work either.
distinct(dg, WSA9_NAME)

# take a small sample of dg.sf to test getting distances
set.seed(1859)
# st_sample only returns a list of coordinates
nla_samp <- st_sample(dg.sf, 10, type = "random", exact = TRUE)
plot(nla_samp)
class(nla_samp)
head(nla_samp)

# sample_n keeps attributes and geometries
nla_samp1 <- sample_n(dg.sf, 10)
plot(nla_samp1, max.plot=1)
class(nla_samp1)
head(nla_samp1$site.id, 10)
distmat <- st_distance(nla_samp1,nla_samp1,by_element = FALSE)
class(distmat) # thought this would return matrix
max(distmat)
min(distmat)
summary(distmat) # think this returns summary of all pairwise distances on each obs, v1-v10
dim(distmat)

rdistmat <- distmat[1:10, ]
print(rdistmat)
rdistmat1 <- as.vector(rdistmat)
round(min(rdistmat1[rdistmat1!=0]))
round(quantile(rdistmat1[rdistmat1!=0], probs=seq(0,1, 0.25), names=F)[2])
round(median(rdistmat1[rdistmat1!=0]))
round(quantile(rdistmat1[rdistmat1!=0], probs=seq(0,1, 0.25), names=F)[4])
round(max(rdistmat1[rdistmat1!=0]))

names(ecoR)
class(ecoR)
# contrast ecoRname <- as.data.frame(select(ecoR,"WSA9_NAME"))
# geom is sticky with select but not pull
# ecoRname <- as.data.frame(pull(ecoR,"WSA9_NAME"))
ecoRname1 <- as.character(pull(ecoR,"WSA9_NAME")) #Springsteen code needs to be character to populate columns of matrix below
class(ecoRname1)
head(ecoRname1, 9)
# initialize summary tables
euc.summary <- matrix(NA, nrow=5, ncol=length(ecoRname1)+1) # initializing blank matrices to fill in the loop
dim(euc.summary)
colnames(euc.summary) <- c("ALL",ecoRname1) #indicates same assignment in each object
rownames(euc.summary) <- c("Min","Q1","Median","Q3","Max")
euc.summary

# Add all distances summary statistics to column 1 of the summary table (i.e. not by region)
euc.summary[,1] <- round(c( min(rdistmat1[rdistmat1!=0]), quantile(rdistmat1[rdistmat1!=0], probs=seq(0,1, 0.25), names=F)[2], median(rdistmat1[rdistmat1!=0]), quantile(rdistmat1[rdistmat1!=0], probs=seq(0,1, 0.25), names=F)[4], max(rdistmat1[rdistmat1!=0]) ),1)

print(euc.summary)

# Unsure that Springsteen function below will work as euc is an spDists created object that I think retained ecoregional & not sure that's so with rdistmat1
# Add within-region summary statistics to summary table 
for (r in 1:length(ecoRname1)){ # loop through regions and fill in the matrices
  euc.reg <- euc[grep(ecoRname1[r], rownames(euc)), grep(ecoRname1[r],colnames(euc))] # retrieving only columns and rows in the distance matrix that contain the same region code in their column/row name
  # retrieving only columns and rows in the distance matrix that contain the same region code in their column/row name
  euc.summary[, (r+1)] <- round(c( min(euc.reg[euc.reg!=0]), quantile(euc.reg[euc.reg!=0], probs=seq(0,1, 0.25), names=F)[2], median(euc.reg[euc.reg!=0]), quantile(euc.reg[euc.reg!=0], probs=seq(0,1, 0.25), names=F)[4], max(euc.reg[euc.reg!=0]) ),1)
}

# Distances for all NLA sites
distmat_dg <- st_distance(dg.sf,dg.sf,by_element = FALSE)
rdistmat_dg <- distmat_dg[1:1185, ]
rdistmat1_dg <- as.vector(rdistmat_dg)

# initialize summary tables
euc.summary_dg <- matrix(NA, nrow=5, ncol=length(ecoRname1)+1) # initializing blank matrices to fill in the loop
dim(euc.summary_dg)
colnames(euc.summary_dg) <- c("ALL",ecoRname1) #indicates same assignment in each object
rownames(euc.summary_dg) <- c("Min","Q1","Median","Q3","Max")


euc.summary_dg[,1] <- round(c( min(rdistmat1_dg[rdistmat1_dg!=0]), quantile(rdistmat1_dg[rdistmat1_dg!=0], probs=seq(0,1, 0.25), names=F)[2], median(rdistmat1_dg[rdistmat1_dg!=0]), quantile(rdistmat1_dg[rdistmat1_dg!=0], probs=seq(0,1, 0.25), names=F)[4], max(rdistmat1_dg[rdistmat1_dg!=0]) ),1)

print(euc.summary_dg)

# brute force to get 5-number summary of ecoregions cut-n-paste ecoregions to get specific data frames:  cpl, nap, npl, sap, spl, tpl, umw, wmt, xer
names(dg.sf)

count(dg.sf, WSA9_NAME) %>% print(n = Inf)

# Get ecoregion-specific NLA sites
cpl <- dg.sf %>% filter(WSA9_NAME == "Coastal Plains")

distmat_cpl <- st_distance(cpl, cpl,by_element = FALSE)
dim(distmat_cpl)
rdistmat_cpl <- distmat_cpl[1:150, ] # change to match # sites/rows
rdistmat1_cpl <- as.vector(rdistmat_cpl)

round(min(rdistmat1_cpl[rdistmat1_cpl!=0]))
round(quantile(rdistmat1_cpl[rdistmat1_cpl!=0], probs=seq(0,1, 0.25), names=F)[2])
round(median(rdistmat1_cpl[rdistmat1_cpl!=0]))
round(quantile(rdistmat1_cpl[rdistmat1_cpl!=0], probs=seq(0,1, 0.25), names=F)[4])
round(max(rdistmat1_cpl[rdistmat1_cpl!=0]))

# GitHub question:  if I save a workspace, .RData, will that be pushed when I push to GitHub?  Or, should data frames go in .gitignore?
```

## Lagged scatterplots
Note that can use simple feature object, such as cpl, for histogram, but spatial object needed for lagged scatterplots.  I took log10 transform to  get data somewhat unimodal and symmetric.
```{r, laggedscatterplot}
# cpl
cpl_sp <- as(cpl, "Spatial")
class(cpl_sp)
ggplot(cpl,aes(dissolved.ch4)) + geom_histogram()
ggplot(cpl,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, cpl_sp, c(0, 50000, 150000, 250000, 500000, 1000000, 1500000))

hscat(dissolved.ch4~1, cpl_sp, c(0, 50000, 150000, 250000, 500000, 1000000, 1500000))

hscat(dissolved.ch4~1, cpl_sp, c(0, 10000, 25000, 50000, 150000, 250000, 500000))

ggplot(cpl,aes(dissolved.co2)) + geom_histogram()
ggplot(cpl,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, cpl_sp, c(0, 50000, 150000, 250000, 500000, 1000000, 1500000))

hscat(dissolved.co2~1, cpl_sp, c(0, 50000, 150000, 250000, 500000, 1000000, 1500000))

hscat(log10(dissolved.co2)~1, cpl_sp, c(0, 10000, 25000, 50000, 150000, 250000, 500000))

ggplot(cpl,aes(dissolved.n2o)) + geom_histogram()
ggplot(cpl,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, cpl_sp, c(0, 50000, 150000, 250000, 500000, 1000000, 1500000))

hscat(dissolved.n2o~1, cpl_sp, c(0, 50000, 150000, 250000, 500000, 1000000, 1500000))

hscat(log10(dissolved.n2o)~1, cpl_sp, c(0, 10000, 25000, 50000, 150000, 250000, 500000))

# nap
nap_sp <- as(nap, "Spatial")
class(nap_sp)
ggplot(nap,aes(dissolved.ch4)) + geom_histogram()
ggplot(nap,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, nap_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(dissolved.ch4~1, nap_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(log10(dissolved.ch4)~1, nap_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

ggplot(nap,aes(dissolved.co2)) + geom_histogram()
ggplot(nap,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, nap_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(dissolved.co2~1, nap_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(log10(dissolved.co2)~1, nap_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

ggplot(nap,aes(dissolved.n2o)) + geom_histogram()
ggplot(nap,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, nap_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(dissolved.n2o~1, nap_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(log10(dissolved.n2o)~1, nap_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

# npl
npl_sp <- as(npl, "Spatial")
class(npl_sp)
ggplot(npl,aes(dissolved.ch4)) + geom_histogram()
ggplot(npl,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, npl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(dissolved.ch4~1, npl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(log10(dissolved.ch4)~1, npl_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

ggplot(npl,aes(dissolved.co2)) + geom_histogram()
ggplot(npl,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, npl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(dissolved.co2~1, npl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(log10(dissolved.co2)~1, npl_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

ggplot(npl,aes(dissolved.n2o)) + geom_histogram()
ggplot(npl,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, npl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(dissolved.n2o~1, npl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(log10(dissolved.n2o)~1, npl_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

# sap
sap_sp <- as(sap, "Spatial")
class(sap_sp)
ggplot(sap,aes(dissolved.ch4)) + geom_histogram()
ggplot(sap,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, sap_sp, c(0, 10000, 50000, 150000, 300000, 450000, 650000))

hscat(dissolved.ch4~1, sap_sp, c(0, 10000, 50000, 150000, 300000, 450000, 650000))

hscat(log10(dissolved.ch4)~1, sap_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

ggplot(sap,aes(dissolved.co2)) + geom_histogram()
ggplot(sap,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, sap_sp, c(0, 10000, 50000, 150000, 300000, 450000, 650000))

hscat(dissolved.co2~1, sap_sp, c(0, 10000, 50000, 150000, 300000, 450000, 650000))

hscat(log10(dissolved.co2)~1, sap_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

ggplot(sap,aes(dissolved.n2o)) + geom_histogram()
ggplot(sap,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, sap_sp, c(0, 10000, 50000, 150000, 300000, 450000, 650000))

hscat(dissolved.n2o~1, sap_sp, c(0, 10000, 50000, 150000, 300000, 450000, 650000))

hscat(log10(dissolved.n2o)~1, sap_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

# spl
spl_sp <- as(spl, "Spatial")
class(spl_sp)
ggplot(spl,aes(dissolved.ch4)) + geom_histogram()
ggplot(spl,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, spl_sp, c(0, 10000, 50000, 150000, 250000, 350000, 500000))

hscat(dissolved.ch4~1, spl_sp, c(0, 10000, 50000, 150000, 250000, 350000, 500000))

hscat(log10(dissolved.ch4)~1, spl_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

ggplot(spl,aes(dissolved.co2)) + geom_histogram()
ggplot(spl,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, spl_sp, c(0, 10000, 50000, 150000, 250000, 350000, 500000))

hscat(dissolved.co2~1, spl_sp, c(0, 10000, 50000, 150000, 250000, 350000, 500000))

hscat(log10(dissolved.co2)~1, spl_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

ggplot(spl,aes(dissolved.n2o)) + geom_histogram()
ggplot(spl,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, spl_sp, c(0, 10000, 50000, 150000, 250000, 350000, 500000))

hscat(dissolved.n2o~1, spl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 400000))

hscat(log10(dissolved.n2o)~1, spl_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

# tpl
tpl_sp <- as(tpl, "Spatial")
class(tpl_sp)
ggplot(tpl,aes(dissolved.ch4)) + geom_histogram()
ggplot(tpl,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, tpl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 600000))

hscat(dissolved.ch4~1, tpl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 600000))

hscat(log10(dissolved.ch4)~1, tpl_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

ggplot(tpl,aes(dissolved.co2)) + geom_histogram()
ggplot(tpl,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, tpl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 600000))

hscat(dissolved.co2~1, tpl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 600000))

hscat(log10(dissolved.co2)~1, tpl_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

ggplot(tpl,aes(dissolved.n2o)) + geom_histogram()
ggplot(tpl,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, tpl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 600000))

hscat(dissolved.n2o~1, tpl_sp, c(0, 10000, 50000, 100000, 200000, 300000, 600000))

hscat(log10(dissolved.n2o)~1, tpl_sp, c(0, 25000, 50000, 75000, 100000, 125000, 150000))

# umw
umw_sp <- as(umw, "Spatial")
class(umw_sp)
ggplot(umw,aes(dissolved.ch4)) + geom_histogram()
ggplot(umw,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, umw_sp, c(0, 10000, 50000, 75000, 100000, 200000, 350000))

hscat(dissolved.ch4~1, umw_sp, c(0, 10000, 50000, 75000, 100000, 200000, 350000))

hscat(log10(dissolved.ch4)~1, umw_sp, c(0, 25000, 50000, 75000, 100000, 250000, 350000))

ggplot(umw,aes(dissolved.co2)) + geom_histogram()
ggplot(umw,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, umw_sp, c(0, 10000, 50000, 75000, 100000, 200000, 350000))

hscat(dissolved.co2~1, umw_sp, c(0, 25000, 50000, 75000, 100000, 250000, 350000))

hscat(log10(dissolved.co2)~1, umw_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

ggplot(umw,aes(dissolved.n2o)) + geom_histogram()
ggplot(umw,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, umw_sp, c(0, 25000, 50000, 75000, 100000, 250000, 350000))

hscat(dissolved.n2o~1, umw_sp, c(0, 25000, 50000, 75000, 100000, 250000, 350000))

hscat(log10(dissolved.n2o)~1, umw_sp, c(0, 25000, 50000, 100000, 200000, 300000, 400000))

# wmt
wmt_sp <- as(wmt, "Spatial")
class(wmt_sp)
ggplot(wmt,aes(dissolved.ch4)) + geom_histogram()
ggplot(wmt,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, wmt_sp, c(0, 10000, 50000, 100000, 200000, 350000, 700000))

hscat(dissolved.ch4~1, wmt_sp, c(0, 10000, 50000, 100000, 200000, 350000, 700000))

hscat(log10(dissolved.ch4)~1, wmt_sp, c(0, 25000, 50000, 100000, 200000, 350000, 700000))

ggplot(wmt,aes(dissolved.co2)) + geom_histogram()
ggplot(wmt,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, wmt_sp, c(0, 10000, 50000, 100000, 200000, 350000, 700000))

hscat(dissolved.co2~1, wmt_sp, c(0, 10000, 50000, 100000, 200000, 350000, 700000))

hscat(log10(dissolved.co2)~1, wmt_sp, c(0, 25000, 50000, 100000, 200000, 350000, 700000))

ggplot(wmt,aes(dissolved.n2o)) + geom_histogram()
ggplot(wmt,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, wmt_sp, c(0, 10000, 50000, 100000, 200000, 350000, 700000))

hscat(dissolved.n2o~1, wmt_sp, c(0, 10000, 50000, 100000, 200000, 350000, 700000))

hscat(log10(dissolved.n2o)~1, wmt_sp, c(0, 25000, 50000, 100000, 200000, 350000, 700000))

# xer
xer_sp <- as(xer, "Spatial")
class(xer_sp)
ggplot(xer,aes(dissolved.ch4)) + geom_histogram()
ggplot(xer,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
# 10 km bin/lag only has 2 points plotted so start with 50 km
hscat(log10(dissolved.ch4)~1, xer_sp, c(0, 50000, 100000, 200000, 400000, 800000))

hscat(dissolved.ch4~1, xer_sp, c(0, 50000, 100000, 200000, 400000, 800000))

hscat(log10(dissolved.ch4)~1, xer_sp, c(0, 25000, 50000, 750000, 100000, 200000, 400000, 800000))

ggplot(xer,aes(dissolved.co2)) + geom_histogram()
ggplot(xer,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, xer_sp, c(0, 50000, 100000, 200000, 400000, 800000))

hscat(dissolved.co2~1, xer_sp, c(0, 50000, 100000, 200000, 400000, 800000))

hscat(log10(dissolved.co2)~1, xer_sp, c(0, 25000, 50000, 750000, 100000, 200000, 400000, 800000))

ggplot(xer,aes(dissolved.n2o)) + geom_histogram()
ggplot(xer,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, xer_sp, c(0, 50000, 100000, 200000, 400000, 800000))

hscat(dissolved.n2o~1, xer_sp, c(0, 50000, 100000, 200000, 400000, 800000))

hscat(log10(dissolved.n2o)~1, xer_sp, c(0, 25000, 50000, 750000, 100000, 200000, 400000, 800000))

# all
dg_sp <- as(dg.sf, "Spatial")
class(dg_sp)
ggplot(dg.sf,aes(dissolved.ch4)) + geom_histogram()
ggplot(dg.sf,aes(dissolved.ch4)) + geom_histogram() + scale_x_log10()
hscat(log10(dissolved.ch4)~1, dg_sp, c(0, 50000, 100000, 200000, 400000, 800000, 1500000))

hscat(dissolved.ch4~1, dg_sp, c(0, 50000, 100000, 200000, 400000, 800000, 1500000))

hscat(log10(dissolved.ch4)~1, dg_sp, c(0, 10000, 25000, 50000, 100000, 200000, 300000, 400000))

ggplot(dg.sf,aes(dissolved.co2)) + geom_histogram()
ggplot(dg.sf,aes(dissolved.co2)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.co2)~1, dg_sp, c(0, 50000, 100000, 200000, 400000, 800000, 1500000))

hscat(dissolved.co2~1, dg_sp, c(0, 50000, 100000, 200000, 400000, 800000, 1500000))

hscat(log10(dissolved.co2)~1, dg_sp, c(0, 10000, 25000, 50000, 100000, 200000, 300000, 400000))

ggplot(dg.sf,aes(dissolved.n2o)) + geom_histogram()
ggplot(dg.sf,aes(dissolved.n2o)) + geom_histogram() + scale_x_log10()

hscat(log10(dissolved.n2o)~1, dg_sp, c(0, 50000, 100000, 200000, 400000, 800000, 1500000))

hscat(dissolved.n2o~1, dg_sp, c(0, 50000, 100000, 200000, 400000, 800000, 1500000))

hscat(log10(dissolved.n2o)~1, dg_sp, c(0, 10000, 25000, 50000, 100000, 200000, 300000, 400000))

````

## Lagged scatterplots
Mike, can you integrate scatterplot code here?

## Semivariograms
Variograms display the variability among pairs of points at various separation distances.  I was unable to fit a model to the dissolved gas concentration variograms using the default fitting parameters in gstat.  The variograms suggest a lack of spatial structure, but I suspect the model parameterization can be improved.

```{r, warning=FALSE, message=FALSE}
# Variogram function requires sp object
dg.sp <- as(dg.sf, Class = "Spatial")

# CO2 variogram
co2.v <- variogram(dissolved.co2~1, dg.sp)
co2.v.fit <- fit.variogram(co2.v, vgm(c("Exp", "Mat", "Sph"))) # allow to choose best model.  Not sure which model warnings are associated with.
# co2.v.fit # chose sperical
co2.v.fit <- fit.variogram(co2.v, vgm("Sph")) # refit spherical, several warnings (?)

# CH4 variogram
ch4.v <- variogram(dissolved.ch4~1, dg.sp)
ch4.v.fit <- fit.variogram(ch4.v, vgm(c("Exp", "Mat", "Sph"))) # allow to choose best model.  Not sure which model warnings are associated with.
# ch4.v.fit # chose exp
ch4.v.fit <- fit.variogram(ch4.v, vgm("Exp")) # refit exponential, no convergence

# N2O variogram
n2o.v <- variogram(dissolved.n2o~1, dg.sp)
n2o.v.fit <- fit.variogram(n2o.v, vgm(c("Exp", "Mat", "Sph"))) # allow to choose best model.  Not sure which model warnings are associated with.
# n2o.v.fit # chose exp
n2o.v.fit <- fit.variogram(n2o.v, vgm("Exp")) # refit exponential, no convergence


# Plot variograms and models (if fit)
plot(co2.v, model = co2.v.fit, main = "CO2 semivariogram")
plot(ch4.v, main = "CH4 semivariogram")
plot(n2o.v, main = "N2O semivariogram")

```







