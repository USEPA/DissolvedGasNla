---
title: "Analysis of NLA17 Dissolved Gas Indicator"
author: "J. Beaulieu"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: false
    fig_caption: yes
    depth: 2
    number_sections: true
---

```{r results='hide', message=FALSE, warning=FALSE}
# load libraries
library(rgdal) # spatial data
library(sf) # spatial data
library(gstat) # lagged scatterplot
library(spdplyr) # apply dplyr verbs to sp objects
library(rmarkdown)
library(tidyverse)
```


# Background
During the 2017 National Lakes Assesment, duplicate dissolved gas samples were collected at a depth of ~0.1m at the index site at each waterbody.  Gas samples were analyzed for CO~2~, CH~4~, and N~2~O concentration via gas chromatography and $\delta^{13}CO_{2}$ and $\delta^{13}CH_{4}$ via cavity ring-down spectroscopy.  The following analysis pertains to the concentration data.


# Data

The dissolved gas data were currated the 'NLA' dissolved gas project in RStudio.  The code can be found at a private github repository (https://github.com/USEPA/NLA).  After aggregating across duplicate samples, the data were written to nla17gasDataAggregated_2019-10-25.txt.  A copy of this data file is stored in documents library associated with the 'ORD NLA17 Dissolved Gas' Private Group on SharePoint (https://usepa.sharepoint.com/sites/ORD_NLA17_Dissolved_Gas).  When synced to a local computer, the documents library can be read directly with R, after identifying the local directory path.

```{r}
# Identify local path for each user
localPath <- Sys.getenv("USERPROFILE")


# Read data file
dg <- read.table(file = paste0(localPath, 
                               "/Environmental Protection Agency (EPA)/",
                               "ORD NLA17 Dissolved Gas - Documents/",
                               "inputData/nla17gasDataAggregated_2019-10-25.txt"), 
                 header = TRUE, sep = "\t", as.is = TRUE)
```
Concentrations of CO~2~, CH~4~, and N~2~O in ambient air over the waterbodies were measured and used in the dissolved gas concentrations.  These data are not needed in subsequent analysis and will be removed from the dataframe.
```{r}
dg <- dg %>% filter(sample.source == "DG") # filter out dissolved gas 'DG' samples
```
The dataframe also contains observations from site in Alaska.  These sites were not an official part of the NLA and will not be included in this analysis.
```{r}
dg <- dg %>% filter(!(grepl("AK", site.id))) # exlclude alaska
```



The data file contains `r dg %>% distinct(site.id, visit.no) %>% summarize(n = n()) %>% pull()` unique sampling trips defined by unique combinations of 'site.id' and 'visit.no'.  There were `r dg %>% distinct(site.id) %>% summarize(n = n()) %>% pull()` waterbodies sampled, `r dg %>% filter(visit.no == 2) %>% summarize(n = n()) %>% pull()` of which were sampled twice. The primary response variables are the concentrations of CO~2~, CH~4~, and N~2~O dissolved in the surface water of each waterbody.  Concentration is expressed as both mol/L (dissolved.co2, dissolved.ch4, dissolved.n2o) and as a saturation ratio (co2.sat.ratio, ch4.sat.ratio, n2o.sat.ratio).  Saturation ratio is defined as the ratio of the measured concentration to that expected if the waterbody were in equilibrium with the atmosphere.  A value of 1 indicates equilibrium, values < 1 indicate undersaturation and values > 1 indicate supersaturation.  Undersaturated waterbodies function as a sink for the atmospheric gas whereas supersaturated waterbodies function as a source.


```{r}
dg %>% select(dissolved.co2, dissolved.ch4, dissolved.n2o, co2.sat.ratio, ch4.sat.ratio, n2o.sat.ratio) %>%
  {summary(.)}
```

To enable spatial analysis of the data, the dataframe will be converted to a 'simple features' (sf) object.
```{r}
# Define coordinates
coords <- data.frame(longitude = dg$map.lon.dd, latitude = dg$map.lat.dd)

dg.sf <- st_as_sf(dg, coords = c("map.lon.dd", "map.lat.dd"), 
                  crs = 4269) %>% # standard for lat/lon
  st_transform(5070) # project to CONUS ALBERS for plotting
```

#  Exploratory spatial analysis

Bubble plots offer a simple method for visualizing spatial patterns in the data.  For some reason, this isn't working.  WTF....

```{r}
# read in ecoregion polygons
ecoR <- st_read(dsn = paste0(localPath, 
                             "/Environmental Protection Agency (EPA)/",
                             "ORD NLA17 Dissolved Gas - Documents/inputData"),
                layer = "Aggr_Ecoregions9_2015")



# "Temperate" is misspelled.
ecoR <- ecoR %>% 
  mutate(WSA9_NAME = as.character(WSA9_NAME), # conv to char
         WSA9_NAME = ifelse(WSA9_NAME == "Temporate Plains",
                            "Temperate Plains", # correct sp
                            WSA9_NAME),
         WSA9_NAME = as.factor(WSA9_NAME)) # back to factor

# Check CRS
st_crs(ecoR) # no EPSG code
ecoR <- st_transform(ecoR, 5070) # convert to CONUS Albers
st_crs(ecoR) # 5070

# Bubble plots
ggplot() +
  geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
  geom_sf(data = dg.sf, aes(size = dissolved.co2)) +
  ggtitle("Dissolved CO2")

ggplot() +
  geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
  geom_sf(data = dg.sf, aes(size = dissolved.ch4)) +
  ggtitle("Dissolved CH4")

ggplot() +
  geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
  geom_sf(data = dg.sf, aes(size = dissolved.n2o)) +
  ggtitle("Dissolved N2O")
```
