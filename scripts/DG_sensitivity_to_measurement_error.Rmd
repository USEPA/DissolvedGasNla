---
title: "Evaluating sensitivity to measurement error in dissolved gas measurements"
author: "Roy Martin, Jake Beaulieu, Michael McManus"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
  pdf_document:
    toc: true
  html_notebook:
    depth: 4
    fig_caption: true
    number_sections: true
    toc: true
    toc_float: true
link-citations: true
---

```{=html}
<style>
.vscroll-plot {
    width: 800px;
    height: 600px;
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>
```
# Background

In this document we explore a range of models for fitting dissolved $\text{N}_2\text{O}$ data observed as part of the 2017 National Lakes Assessment (NLA).

# Setup R

```{r setup_1, include=FALSE, echo=FALSE}
library(knitr)
# opts_knit$set(root.dir = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/scripts")
# 
# #set directories and R package library
# setwd("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/scripts")
# .libPaths("C:/Users/rmartin/Desktop/R/library")
```

```{r load_packages, warning=FALSE, message=FALSE}
library(brms)
library(bayesplot)
library(kableExtra)
library(tidyverse)
library(ggplot2)
library(ggExtra)
library(gridExtra)
library(readxl)
library(janitor)
library(sf)

options(mc.cores = parallel::detectCores())
options( max.print = 2000 )
```

```{r utility_functions, include=FALSE}
# Identify local path for each user
localPath <- Sys.getenv("USERPROFILE")

# Define helper functions
# standardized formatting for column names
toEPA <- function(X1){
  names(X1) = tolower(names(X1))
  names(X1) = gsub(pattern = c("\\(| |#|)|/|-|\\+|:|_"), replacement = ".", x = names(X1))
  X1
}

#Calc geometric mean
gm_mean = function(x, na.rm=TRUE, zero.propagate = FALSE){
  if(any(x < 0, na.rm = TRUE)){
    return(NaN)
  }
  if(zero.propagate){
    if(any(x == 0, na.rm = TRUE)){
      return(0)
    }
    exp(mean(log(x), na.rm = na.rm))
  } else {
    exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
  }
}

gm_sd = function(x, na.rm=TRUE, zero.propagate = FALSE){
  if(any(x < 0, na.rm = TRUE)){
    return(NaN)
  }
  if(zero.propagate){
    if(any(x == 0, na.rm = TRUE)){
      return(0)
    }
    exp(sd(log(x), na.rm = na.rm))
  } else {
    exp(sd(log(x[x > 0]), na.rm=na.rm) / length(x))
  }
}

#calculate skew
MySkew <- function(x) {
     n <- length(x)
     v <- var(x)
     m <- mean(x)
     third.moment <- (1/(n - 2)) * sum((x - m)^3)
     third.moment/(var(x)^(3/2))
 }

#Center and scale by (1) sd
MyStd <- function(x){ (x-mean(x))/(sd(x)*2)}

#First letter in string to uppercase
firstup <- function(x) {
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  x}
```

# Dissolved gas concentration calculation

The full equation for estimating the concentration (nM) of $N_20$ gas dissolved in water is:

$$C = 1^{-6}B \frac{V_{air}(Mr_h - Mr_r)}{(8.3144598 * K * V_{water}) + H^{\theta} \exp( 2700 * ( \frac{1}{K} - \frac{1}{298.15}) * Mr_h}$$

# Set up model for simulating true dissolved N2O value

```{r setvars_and_check}
load(paste0(localPath, "\\Environmental Protection Agency (EPA)",
            "\\ORD NLA17 Dissolved Gas - Documents\\",
            "inputData\\dg.2021-02-01.RData"))

# summary of measured N2O ppm in equilibrated headspace gas
dg %>%
  group_by(sample.source) %>%
  summarize(mean_n2O = mean(n2o.ppm.gc, na.rm = TRUE),
          median_n2o = median(n2o.ppm.gc, na.rm = TRUE)) #mean = 0.36, median = 0.31

#    mean_n2o  median_n2o
#AIR	0.3093312	0.3104941		
#DG	 0.3618681	0.3067609	


B <- 99 # barometric pressure (kPa)
V_g <- 35 # volume of reference gas in headspace
V_w <- 105 # volume of water below headspace
T_c <- 23 # temperature ( C )
C_e <- 0.307 # gas mixture ratio in headspace
C_a_n2o <- 0.310 # gas mixture ratio in reference
H_n2o <- 0.00024 #mol m-3 Pa, range: 0.00018 - 0.00025; Henry's law constant
H_ar <- 0.000014 #mol m-3 Pa, range: 0.000013 - 0.000016; Henry's law constant

C <- 1e-6 * B * ( V_g * ( C_e - C_a_n2o ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e ) 

C <- C * 1e9 #convert mol to nmol

round( C, 1 ) 

```

## Define GC measurement error

Measurement error will be defined as standard deviation of repeated analysis of analytical standards throughout the period of time that the NLA2017 samples were analyzed.

```{r get_gc_error}
# READ GC DATA----------------
##########################################################################
#       Code is commented out because collaborators may not have access  #
#       to the file paths. The calculated standard deviation is hard     #
#       coded below.
##########################################################################

# Below we read raw GC data into the environment, extract repeat analysis of
# an analytical standard, then calculate the standard deviation of the replicate
# measurements.

# gc.1 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_06_29_STD_ECD_FID_UNK.xlsx", 
#                    trim_ws = TRUE, skip=59) 
# gc.2 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_07_25_UNK_STD_ECD_FID.xlsx", 
#                    trim_ws = TRUE, skip=59)
# gc.3 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_08_02_UNK_STD_ECD_FID.xlsx", 
#                    trim_ws = TRUE, skip=50)
# gc.4 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_08_04_UNK_STD_ECD_FID.xlsx", 
#                    trim_ws = TRUE, skip=50)
# gc.5 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_08_16_Dgas_UNK_STD_ECD_FID.xlsx", 
#                    trim_ws = TRUE, skip=62)
# gc.6 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_08_21_UNK_STD_ECD_FID.xlsx", 
#                    trim_ws = TRUE, skip=62)
# gc.7 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_08_31_UNK_STD_ECD_FID2.xlsx", 
#                    trim_ws = TRUE, skip=65)
# gc.8 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_09_14_UNK_STD_ECD_FID.xlsx", 
#                    trim_ws = TRUE, skip=62)
# gc.9 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_09_19_STD_UNK_ECD_FID_TCD.xlsx", 
#                    trim_ws = TRUE, skip=102)
# gc.10 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_09_28_UNK_STD_ECD_FID.xlsx", 
#                    trim_ws = TRUE, skip=50)
# gc.11 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_10_11_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.12 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_10_17_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.13 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_12_20_STD_UNK_ECD_FID.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.14 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_01_03_AIR_UNK_STD_ECD_FID.xlsx", 
#                     trim_ws = TRUE, skip=48)
# gc.15 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_01_09_FID_ECD_STD.xlsx", 
#                     trim_ws = TRUE, skip=48)
# gc.16 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_01_16_UNK_STD_ECD_FID.xlsx", 
#                     trim_ws = TRUE, skip=48)
# gc.17 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_01_22_UNK_STD_ECD_FID.xlsx", 
#                     trim_ws = TRUE, skip=60)
# gc.18 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_01_31_STD_UNK_ECD_FID_TCD.xlsx", 
#                     trim_ws = TRUE, skip=102)
# gc.19 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_02_05_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.20 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_02_09_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.21 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_02_12_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.22 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_02_16_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.23 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_02_20_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.24 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/17_04_25_UNK_STD_ECD_FID.xlsx", 
#                     trim_ws = TRUE, skip=72)
# gc.25 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_02_23_UNK_STD_ECD_FID_Dgas.xlsx", 
#                     trim_ws = TRUE, skip=67)
# gc.26 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_02_27_UNK_STD_ECD_FID_DP.xlsx", 
#                     trim_ws = TRUE, skip=72)
# gc.27 <- read_excel("L:/Lab/Lablan/GHG/GC/2017Data/18_03_05_Trap_6ml.xlsx", 
#                     trim_ws = TRUE, skip=104)
# # Merge gas data
# gc.all <- Reduce(function(...) merge(..., all=T),
#                   list(gc.1, gc.2, gc.3, gc.4, gc.5, gc.6, gc.7, 
#                        gc.8, gc.9, gc.10, gc.11, gc.12, gc.13, gc.14, gc.15, 
#                        gc.16, gc.17, gc.18, gc.19, gc.20, gc.21, gc.22, gc.23, 
#                        gc.24, gc.25, gc.26, gc.27)) %>%
#   janitor::clean_names()
# 
# 
# # Format gas data
# gc.std <- gc.all %>% 
#   select( sample, contains("n2O")) %>%
#   filter(grepl("std", sample, ignore.case = TRUE)) %>% # only keep standards
#   mutate(sample = tolower(sample), # simplify formatting
#          # we have multiple injections of this 1.8 Prax Air standard
#          sample = case_when(grepl("1.8 prax", sample, ignore.case = TRUE) ~ "1.8prax",
#                             TRUE ~ sample))
# 
# # with some invenstigating we could pull out multiple standards used
# # across and within runs to calculate standard deviation, but the 27
# # replicate injections of the 1.8 prax standard is low hanging fruit
# gc.prax <- gc.std %>%
#   filter(sample == "1.8prax")
# 
# gc.prax %>%
#   ggplot(aes(x = n2o_ppm)) +
#   geom_histogram()
# 
# n2o_sd <- sd(gc.prax$n2o_ppm) # 0.007872511ppm
n2o_sd_epa <- 0.007872511 # from AWBERC GC

# # begin digging for other standards to work with
# gc.std %>%
#   filter(grepl("3p", sample, ignore.case = TRUE)) %>%
#   ggplot(aes(sample,n2o_ppm)) +
#   geom_point()
# 
# # list items 17 and 18 contain "m3p chk std"
# # see if these are same standards
# map(list(gc.1, gc.2, gc.3, gc.4, gc.5, gc.6, gc.7, 
#          gc.8, gc.9, gc.10, gc.11, gc.12, gc.13, gc.14, gc.15, 
#          gc.16, gc.17, gc.18, gc.19, gc.20, gc.21, gc.22, gc.23, 
#          gc.24, gc.25, gc.26, gc.27),
#     function(x) {
#       x %>% janitor::clean_names(.) %>% 
#         filter(grepl("m3p chk std", sample, ignore.case = TRUE))
#     })
# 
# table(gc.std$sample)




```

## Simulate measurement error in GC measurement of N2O in equilibrated headspace

```{r simulate_me_Ce, message=F}
C_me <- rep( NA, 1e4 ) # "me" is "measured" gas in headspace. empty vector

# this simulates measurement error on GC.
# assume TRUE value is C_e and error is simulated with with sd of replicate GC measurements
C_e_me <- rnorm( 1e4, C_e, n2o_sd_epa ) # me in measured gas in headspace.
                                   # add random error to measured concentration

for( i in 1:length( C_me ) ){
  C_me[ i ] <- 1e-6 * B * ( V_g * ( C_e_me[ i ] - C_a_n2o ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e_me[ i ] )
}

# combine into dataframe for ggplot. qplot, which acceptes vectors,
# was deprecated in ggplot 3.4.0
C_df <- tibble(C_me = C_me, C_e_me = C_e_me)

ggplot(C_df, aes(x = C_e_me )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = C_e , color = 'red' ) + 
  ggtitle( "Simulated measurement error in equilibrated gas concentration") +
  xlab( "concentration (nmol L-1)")

ggplot(C_df, aes(x = C_me * 1e9 )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to GC measurment error \nof equilibrated headspace") +
  xlab( "concentration (nMol)")

ggplot(C_df, aes(x = C_me * 1e9 - C )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to GC measurment error \nof equilibrated headspace") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error for GC measurement of N2O in air

```{r simulate_me_Ca, message=F}
C_me <- rep( NA, 1e4 )

C_a_n2o_me <- rnorm( 1e4, C_a_n2o, n2o_sd_epa ) #m.e. in measured gas in air

for( i in 1:length( C_me ) ){
  C_me[ i ] <- 1e-6 * B * ( V_g * ( C_e - C_a_n2o_me[ i ] ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e )
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
Ca_df <- tibble(C_me = C_me, C_a_n2o_me = C_a_n2o_me)

ggplot(Ca_df, aes(x = C_a_n2o_me )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = C_a_n2o , color = 'red' ) + 
  ggtitle( "Simulated measurement error in air gas concentration") +
  xlab( "concentration (?)")

ggplot(Ca_df, aes(x = C_me * 1e9 )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to GC measurment error \nof N2O in air") +
  xlab( "concentration (nMol)")

ggplot(Ca_df, aes(x = C_me * 1e9 - C )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O concentration due to GC measurment error \nof N2O in air") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error in $C_e$ and $C_a_n2o$

```{r simulate_me_Ca_Ce, message=F}
C_me <- rep( NA, 1e4 )

for( i in 1:length( C_me ) ){
  C_me[ i ] <- 1e-6 * B * ( V_g * ( C_e_me[ i ] - C_a_n2o_me[ i ] ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e_me[ i ] )
}

# combine into dataframe for ggplot. qplot, which acceptes vectors,
# was deprecated in ggplot 3.4.0
C_df <- tibble(C_me = C_me)

ggplot(C_df, aes(x = C_me * 1e9 )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to GC measurment error \nof 
           N2O in equilibrated headspace and air") +
  xlab( "concentration (nMol)")

ggplot(C_df, aes(x = C_me * 1e9 - C )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to GC measurment error \nof N2O in equilibrated headspace and air") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error in water temperature

```{r simulate_me_T_c, message=F}
C_me <- rep( NA, 1e4 )

# How to get standard deviation of temperature measurement?
# calibration certificate reports an uncertainty of +/-0.058C
# take standard deviation of simulated measurements with specified uncertainty
T_c_sd <- sd(runif(n = 1e4, min = T_c - 0.058, max = T_c + 0.058)) # calibration certificate reports an uncertainty of +/-0.058C
T_c_me <- rnorm( 1e4, T_c, T_c_sd ) #m.e. in measured water temp

for( i in 1:length( C_me ) ){
  C_me[ i ] <- 1e-6 * B * ( V_g * ( C_e - C_a_n2o ) / ( 8.3144598 * ( T_c_me[ i ] + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c_me[ i ] + 273.15 ) - 1 / 298.15 ) ) * C_e )
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_df <- tibble(C_me = C_me, T_c_me = T_c_me)

ggplot(C_df, aes(x = T_c_me )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = T_c , color = 'red' ) + 
  ggtitle( "Simulated measurement error in temperature") +
  xlab( "temperature (C)")

ggplot(C_df, aes( x = C_me * 1e9 )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to water temperature \nmeasurment error") +
  xlab( "concentration (nMol)")

ggplot(C_df, aes( x = C_me * 1e9 - C )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to water temperature \nmeasurment error") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error in barometric pressure

```{r simulate_me_B, message=F}
C_me <- rep( NA, 1e4 )

# How to get standard deviation of barometric pressure?
# The manual reports an "accuracy" of +/-3 mm Hg (+/-0.4kPa), but EPA calibration
# checks performed in the AWBERC metrology lab demonstrate much greater precision.
# below we calculat sd of replicate measurements made with 15 different barometers.
# we then take the mean of the 15 sd values.

#2023 barometer verification in AWBERC metrology lab
B_sd <- mean(
  sd(c(999,998.6)*0.1), # YSI ProDSS
  sd(c(1000.848, 1000.848)*0.1), # EXO 21G104022
  sd(c(1000.982, 1000.982)*0.1), # EXO 18H111572
  sd(c(1000.982, 1000.982)*0.1), # EXO 22F105975
  sd(c(1001.382, 1001.382)*0.1), # EXO 21K100162
  sd(c(1000.98, 1000.85)*0.1), # EXO 21F103579
  sd(c(1000.31, 1000.44)*0.1), # MDS 16D100327
  sd(c(1001.25, 1001.25)*0.1), # MDS 12F102618
  sd(c(1000, 1000)*0.1), # MDS 16D100328
  sd(c(1002, 1002)*0.1), # MDS 02K599 AF
  sd(c(1003,1003)*0.1), # MDS 12J0793 AF
  sd(c(1000.85,1000.85)*0.1), # MDS 16E100831
  sd(c(1000.32, 1000.32)*0.1), # MDS 12F102619
  sd(c(1002, 1002)*0.1)) # MDS 15F104725

B_me <- rnorm( 1e4, B, B_sd ) #m.e. in measured barometric pressure

for( i in 1:length( C_me ) ){
  C_me[ i ] <- 1e-6 * B_me[ i ] * ( V_g * ( C_e - C_a_n2o ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e )
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_df <- tibble(C_me = C_me, B_me = B_me)


ggplot(C_df, aes( x = B_me )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = B , color = 'red' ) + 
  ggtitle( "Simulated measurement error in barometric pressure") +
  xlab( "barometric pressure (kPa)")


ggplot(C_df, aes( x = C_me * 1e9 )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to barometric pressure \nmeasurment error") +
  xlab( "concentration (nMol)")

ggplot(C_df, aes( x = C_me * 1e9 - C )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to barometric pressure \nmeasurment error") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error in water volume

```{r simulate_me_V_w, message=F}
C_me <- rep( NA, 1e4 )

V_w_me <- rnorm( 1e4, V_w, 1 ) #m.e. in measured water volume
V_g_me <- 140 - V_w_me

for( i in 1:length( C_me ) ){
  C_me[ i ] <- 1e-6 * B * ( V_g_me[ i ] * ( C_e - C_a_n2o ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w_me[ i ] ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e )
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_df <- tibble(C_me = C_me, V_w_me = V_w_me)

ggplot(C_df, aes( x = V_w_me )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = V_w , color = 'red' ) + 
  ggtitle( "Simulated measurement error in water volume") +
  xlab( "water vol (mL)")

ggplot(C_df, aes( x = C_me * 1e9 )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissollved N2O concentration due to water volume \nmeasurment error") +
  xlab( "concentration (nMol)")

ggplot(C_df, aes( x = C_me * 1e9 - C )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O concentration due to measurment error") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error for all observables

```{r simulate_me_all, message=F}
C_me <- rep( NA, 1e4 )

for( i in 1:length( C_me ) ){
  C_me[ i ] <- 1e-6 * B_me[ i ] * ( V_g_me[ i ] * ( C_e_me[ i ] - C_a_n2o_me[ i ] ) / ( 8.3144598 * ( T_c_me[ i ] + 273.15 ) * V_w_me[ i ] ) + H_n2o * exp( 2700 * ( 1 / ( T_c_me[ i ] + 273.15 ) - 1 / 298.15 ) ) * C_e )
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_df <- tibble(C_me = C_me)

ggplot(C_df, aes( x = C_me * 1e9 )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to cumulative \nmeasurment errors") +
  xlab( "concentration (nMol)")

ggplot(C_df, aes( x = C_me * 1e9 - C )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to cumulative \nmeasurment errors") +
  xlab( "absolute error (nMol)")

# standard deviation of a measurement is:
sd(C_me* 1e9) # 0.15 nmol L-1, as compared to 1.25 nmol L-1 in Webb et al.

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me* 1e9) * 1.96 # +/- 0.302 nmol N2O
```

## Incorporate measurement uncertainty into source/sink status

The standard deviation of dissolved gas concentration measurements is `r sd(C_me* 1e9)`nM which compares well to 1.25nM reported by Webb et al. The 95% confidence interval is calculated as +/-2sd, which in this case is `r sd(C_me* 1e9) * 1.96`nM. Therefore any dissolved gas concentration that is within `r sd(C_me* 1e9) * 1.96`nM of the equilibrium value cannot be determined as a source or a sink.

```{r map_table, message=F}
# two standard deviations = 0.3019449
# 95% CI is therefore x+/-0.3019449

dg <- dg %>%
  mutate(n2o.src.snk.with.error = case_when(
    abs(dissolved.n2o.nmol - sat.n2o.nmol) > sd(C_me* 1e9) * 1.96 ~ n2o.src.snk,
    TRUE ~ "undetermined")) 

dg %>% 
  filter(sample.source == "DG", visit.no == 1, sitetype == "PROB") %>%
  {table(.$n2o.src.snk.with.error)} %>%
  kable(digits = 2, caption = "Number of lakes classified as source/sink")

dg %>% 
  filter(sample.source == "DG", visit.no == 1, sitetype == "PROB") %>%
  {prop.table(table(.$n2o.src.snk.with.error))} %>%
  kable(digits = 2, caption = "Proportion of lakes classified as source/sink")

## load ecoregions----
# read in ecoregion polygons
ecoR <- st_read(dsn = paste0(localPath, 
                             "/Environmental Protection Agency (EPA)/",
                             "ORD NLA17 Dissolved Gas - Documents/inputData"),
                layer = "aggr_ecoregions_simple",
                quiet = TRUE)

# Check CRS
#st_crs(ecoR) # 3857
ecoR <- st_transform(ecoR, 5070) # convert to CONUS Albers
#st_crs(ecoR) # 5070

# SET UP CUSTOM COLORS FOR ECOREGIONS
# Custom color pallette for ecoregion polygons. Attempted to mirror
# https://www.epa.gov/national-aquatic-resource-surveys/
# ecoregional-results-national-lakes-assessment-2012
cols <- c("Coastal Plains" = "orange1",
          "Northern Appalachians" = "lightpink1",
          "Northern Plains" = "darksalmon",
          "Southern Appalachians" = "mediumturquoise",
          "Southern Plains" = "khaki4",
          "Temperate Plains" = "forestgreen", 
          "Upper Midwest" = "deepskyblue4",
          "Western Mountains" = "saddlebrown",
          "Xeric" = "lightskyblue4")


## Load state boundaries----
states <- USAboundaries::us_states() %>%
  dplyr::filter(!state_name %in% c("Alaska", "District of Columbia", "Hawaii", "Puerto Rico")) %>%
  st_transform(5070) # convert to CONUS Albers
 
# To enable spatial analysis of the data, the dataframe will be converted to a 
# 'simple features' (sf) object.
# Define coordinates
coords <- data.frame(longitude = dg$map.lon.dd, latitude = dg$map.lat.dd)

dg.sf <- st_as_sf(dg, coords = c("map.lon.dd", "map.lat.dd"), 
                  crs = 4269) %>% # standard for lat/lon
  st_transform(5070) # project to CONUS ALBERS for plotting


## Map
ggplot() +
    geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
    geom_sf(data = dg.sf %>% 
              filter(!is.na(n2o.src.snk), sitetype == "PROB", visit.no == 1) %>%
              arrange(desc(n2o.src.snk.with.error)), # grey on top of black
            aes(size = dissolved.n2o.nmol, color = n2o.src.snk.with.error),
            show.legend = "point") +
    geom_sf(data = states, fill = NA, color = "cornsilk3", size = 0.1) +
    # guide argument below removes points from the boxes in the ecoregion legend
    # https://aosmith.rbind.io/2020/07/09/ggplot2-override-aes/
    scale_fill_manual("Ecoregion", values = cols,
                      guide = guide_legend(override.aes = list(shape = NA))) +
    scale_color_manual(values = c("grey", "black", "orange"), name = "source/sink") +
    scale_size(name = expression(N[2]*O~(nM)),
               range = c(0.1, 10), # custom size range
               breaks = c(1, 10, 25, 50, 100)) + # custom breaks
    theme(legend.key.size = unit(0.4, "cm"), # size of boxes in legend
          legend.title = element_text(size = 8))
```

# Set up model for simulating true saturation concentration

The full equation for estimating the concentration (nM) of $N_20$ gas dissolved in water that is in equilibrium with the atmosphere is:

$$C_{sat} = 1^{-6}B*C_{air}*(H^{\theta}*exp(2700* \frac{1}{Tc} -  \frac{1}{298.15}))$$

```{r c_sat}
C_sat <- C_a_n2o * B * 1e-6 * (H_n2o  * exp(2700*(1/(T_c + 273.15) - 1/298.15))) 

C_sat <- C_sat * 1e9 #convert mol to nmol


```

## Simulate measurement error in GC measurement of N2O in air

```{r simulate_me_sat_C_a_n2o, message=F}
C_me_sat <- rep( NA, 1e4 )

C_a_n2o_me <- rnorm( 1e4, C_a_n2o, n2o_sd_epa ) #m.e. in measured gas in air


for( i in 1:length( C_me_sat ) ){
    C_me_sat[i] <- C_a_n2o_me[i] * B * 1e-6 * (H_n2o  * exp(2700*(1/(T_c + 273.15) - 1/298.15)))
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_sat_df <- tibble(C_me_sat = C_me_sat, C_a_n2o_me = C_a_n2o_me)

ggplot(C_sat_df, aes(x = C_a_n2o_me )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = C_a_n2o , color = 'red' ) + 
  ggtitle( "Simulated measurement error in air gas concentration") +
  xlab( "concentration (ppm)")

ggplot(C_sat_df, aes(x = C_me_sat * 1e9 )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C_sat , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to GC measurment error \nof N2O in air") +
  xlab( "concentration (nMol)")

ggplot(C_sat_df, aes(x = C_me_sat * 1e9 - C_sat )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to GC measurment error \nof N2O in air") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error in water temperature

```{r simulate_me_sat_T_c, message=F}
C_me_sat <- rep( NA, 1e4 )

for( i in 1:length( C_me_sat ) ){
    C_me_sat[i] <- C_a_n2o * B * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_me[ i ] + 273.15) - 1/298.15)))
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_sat_df <- tibble(C_me_sat = C_me_sat, T_c_me = T_c_me)


ggplot(C_sat_df, aes(x = T_c_me )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = T_c , color = 'red' ) + 
  ggtitle( "Simulated measurement error in temperature") +
  xlab( "temperature (C)")

ggplot(C_sat_df, aes( x = C_me_sat * 1e9 )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline(xintercept = C_sat , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to water temperature \nmeasurment error") +
  xlab( "concentration (nMol)")

ggplot(C_sat_df, aes( x = C_me_sat * 1e9 - C_sat )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to water temperature \nmeasurment error" ) +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error in barometric pressure

```{r simulate_me_sat_B, message=F}
C_me_sat <- rep( NA, 1e4 )

for( i in 1:length( C_me_sat ) ){
    C_me_sat[i] <- C_a_n2o * B_me[ i ] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c + 273.15) - 1/298.15)))
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_sat_df <- tibble(C_me_sat = C_me_sat, B_me = B_me)


ggplot(C_sat_df, aes( x = B_me )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = B , color = 'red' ) + 
  ggtitle( "Simulated measurement error in barometric pressure") +
  xlab( "barometric pressure (kPa)")

ggplot(C_sat_df, aes( x = C_me_sat * 1e9 )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = C_sat , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to barometric pressure \nmeasurment error") +
  xlab( "concentration (nMol)")

ggplot(C_sat_df, aes( x = C_me_sat * 1e9 - C_sat )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to barometric pressure \nmeasurment error") +
  xlab( "absolute error (nMol)")
```

## Simulate measurement error for all observables

```{r simulate_me_sat_all, message=F}
C_me_sat <- rep( NA, 1e4 )

for( i in 1:length( C_me_sat ) ){
    C_me_sat[i] <- C_a_n2o_me[ i ] * B_me[ i ] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_me[ i ] + 273.15) - 1/298.15)))
}

# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_sat_df <- tibble(C_me_sat = C_me_sat)

ggplot(C_sat_df, aes( x = C_me_sat * 1e9 )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C_sat , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to cumulative \nmeasurment errors") +
  xlab( "concentration (nMol)")

ggplot(C_sat_df, aes( x = C_me_sat * 1e9 - C_sat )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in saturated N2O concentration due to cumulative \nmeasurment errors") +
  xlab( "absolute error (nMol)")

# standard deviation of a measurement is:
sd(C_me_sat* 1e9) # 0.20 nmol L-1

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me_sat * 1e9) * 1.96 # +/- 0.395 nmol N2O
```

# Set up model for simulating true saturation ratio

The full equation for estimating the saturation ratio of $N_20$ gas dissolved in water is:

$$C_ratio = \frac{1^{-6}B \frac{V_{air}(Mr_h - Mr_r)}{(8.3144598 * K * V_{water}) + H^{\theta} \exp( 2700 * ( \frac{1}{K} - \frac{1}{298.15}) * Mr_h}}{1^{-6}B*C_{air}*exp(2700* \frac{1}{Tc} -  \frac{1}{298.15})}$$

```{r}

C_ratio <- (1e-6 * B * ( V_g * ( C_e - C_a_n2o ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e )) /
  (C_a_n2o * B * 1e-6 * (H_n2o  * exp(2700*(1/(T_c + 273.15) - 1/298.15)))) 

```

## Simulate measurement error for all observables when air is used as headspace gas

```{r simulate_me_ratio_all, message=F}
C_me_ratio <- rep( NA, 1e4 )

for( i in 1:length( C_me_ratio ) ){
C_me_ratio[ i ] <- (1e-6 * B_me[i] * ( V_g_me[i] * ( C_e_me[i] - C_a_n2o_me[i] ) / ( 8.3144598 * ( T_c_me[i] + 273.15 ) * V_w_me[i] ) + H_n2o * exp( 2700 * ( 1 / ( T_c_me[i] + 273.15 ) - 1 / 298.15 ) ) * C_e_me[i] )) /
  (C_a_n2o_me[i] * B_me[i] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_me[i] + 273.15) - 1/298.15)))) 
}


# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_ratio_df <- tibble(C_me_ratio = C_me_ratio)

ggplot(C_ratio_df, aes( x = C_me_ratio )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C_ratio , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors") +
  xlab( "saturation ratio")

ggplot(C_ratio_df, aes( x = C_me_ratio - C_ratio )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors") +
  xlab( "absolute error (saturation ratio)")

# standard deviation of a saturation ratio value s:
sd(C_me_ratio) # 0.026

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me_ratio) * 1.96 # +/- 0.05258214

# so any ratio within 0.05 of 1.0 cannot be discerned as a source or sink?
```

## Map of saturation ratio values with uncertainty when air is used as headspace gas

```{r map_sat_ratio, message=F}
# two standard deviations = 0.3019449
# 95% CI is therefore x+/-0.3019449

dg <- dg %>%
  mutate(n2o.src.snk.with.all.error = case_when(
    abs(n2o.sat.ratio - 1) < sd(C_me_ratio) ~ "undetermined",
    TRUE ~ n2o.src.snk)) 

dg %>% 
  filter(sample.source == "DG", visit.no == 1, sitetype == "PROB") %>%
  {table(.$n2o.src.snk.with.all.error)} %>%
  kable(digits = 2, caption = "Number of lakes classified as source/sink")

dg %>% 
  filter(sample.source == "DG", visit.no == 1, sitetype == "PROB") %>%
  {prop.table(table(.$n2o.src.snk.with.all.error))} %>%
  kable(digits = 2, caption = "Proportion of lakes classified as source/sink")

# sf for plotting
dg.sf <- st_as_sf(dg, coords = c("map.lon.dd", "map.lat.dd"), 
                  crs = 4269) %>% # standard for lat/lon
  st_transform(5070) # project to CONUS ALBERS for plotting



## Map
ggplot() +
    geom_sf(data = ecoR, color = NA, aes(fill = WSA9_NAME)) +
    geom_sf(data = dg.sf %>% 
              filter(!is.na(n2o.src.snk), sitetype == "PROB", visit.no == 1) %>%
              arrange(desc(n2o.src.snk.with.all.error)), # grey on top of black
            aes(size = dissolved.n2o.nmol, color = n2o.src.snk.with.all.error),
            show.legend = "point") +
    geom_sf(data = states, fill = NA, color = "cornsilk3", size = 0.1) +
    # guide argument below removes points from the boxes in the ecoregion legend
    # https://aosmith.rbind.io/2020/07/09/ggplot2-override-aes/
    scale_fill_manual("Ecoregion", values = cols,
                      guide = guide_legend(override.aes = list(shape = NA))) +
    scale_color_manual(values = c("grey", "black", "orange"), name = "source/sink") +
    scale_size(name = expression(N[2]*O~(nM)),
               range = c(0.1, 10), # custom size range
               breaks = c(1, 10, 25, 50, 100)) + # custom breaks
    theme(legend.key.size = unit(0.4, "cm"), # size of boxes in legend
          legend.title = element_text(size = 8))
```

## Simulate measurement error for all observables when a pure gas (e.g. helium, nitrogen) is used as headspace gas

```{r simulate_me_ratio_pure_gas_all, message=F}
# set C_e to a lower value to generate a saturation ratio close to that used above
# C_e will be lower due to dilution with pure headspace gas (e.g. helium, nitrogen)
C_e <- 0.2


# this simulates measurement error on GC.
# assume TRUE value is C_e and error is simulated with with sd of replicate GC measurements
C_e_me <- rnorm( 1e4, C_e, n2o_sd_epa ) # me in measured gas in headspace.
                                   # add random error to measured concentration

# under this scenario we don't need to subtract C_a_n2o (N2O concentration in air) from C_e (N2O concentration in equilibrated headspace)
C_ratio <- (1e-6 * B * ( V_g * ( C_e - 0 ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e )) /
  (C_a_n2o * B * 1e-6 * (H_n2o  * exp(2700*(1/(T_c + 273.15) - 1/298.15))))





C_me_ratio <- rep( NA, 1e4 )

for( i in 1:length( C_me_ratio ) ){
C_me_ratio[ i ] <- (1e-6 * B_me[i] * ( V_g_me[i] * ( C_e_me[i] - 0 ) / ( 8.3144598 * ( T_c_me[i] + 273.15 ) * V_w_me[i] ) + H_n2o * exp( 2700 * ( 1 / ( T_c_me[i] + 273.15 ) - 1 / 298.15 ) ) * C_e_me[i] )) /
  (C_a_n2o_me[i] * B_me[i] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_me[i] + 273.15) - 1/298.15)))) 
}


# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_ratio_df <- tibble(C_me_ratio = C_me_ratio)

ggplot(C_ratio_df, aes( x = C_me_ratio )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C_ratio , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors") +
  xlab( "saturation ratio")

ggplot(C_ratio_df, aes( x = C_me_ratio - C_ratio )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors") +
  xlab( "absolute error (saturation ratio)")

# standard deviation of a saturation ratio value s:
sd(C_me_ratio) # 0.048

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me_ratio) * 1.96 # +/- 0.094

# so any ratio within 0.094 of 1.0 cannot be discerned as a source or sink
```


## Simulate measurement error for all observables when a pure gas (e.g. helium, nitrogen) is used as headspace gas combined with high precision GC

The GC used in the current study is optimized to quantify several analytes across a broad range of concentrations but greater precision can be achieved by optimizing the instrument for a single analyte across a narrower range of concentrations.  For example,  laboratories participating in an international analysis of N2O standards used for atmsopheric monitoring reported a mean standard deviation of `r mean(c(.00033, .00034, .00031, 0.00030, 0.0016, 0.0015))`, which is 10-fold lower than the standard deviation of N2O measurements in this study (`r n2o_sd_epa`).  Utilizing more precise N2O measurements for the equilibrated headspace and/or air will reduce uncertainty in the estimated dissolved N2O concentration, dissolved N2O equilibrium value, and N2O saturation ratio.

```{r simulate_me_ratio_gc_pure_gas_all, message=F}
# set C_e to a lower value to generate a saturation ratio close to that used above
# C_e will be lower due to dilution with pure headspace gas (e.g. helium, nitrogen)
C_e <- 0.2

# two standard deviations reported from each of three labs participating in
# a laboratory intercomparison study
n2o_sd_lit <- mean(c(.00033, .00034, .00031, 0.00030, 0.0016, 0.0015)) # from literature

# simulate improved measurement of N2O in equilibrated headspace gas 
# assume TRUE value is C_e and error is simulated with with sd from literature
C_e_me <- rnorm( 1e4, C_e, n2o_sd_lit ) 

# under this scenario we don't need to subtract C_a_n2o (N2O concentration in air) from C_e (N2O concentration in equilibrated headspace)
C_ratio <- (1e-6 * B * ( V_g * ( C_e - 0 ) / ( 8.3144598 * ( T_c + 273.15 ) * V_w ) + H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) * C_e )) /
  (C_a_n2o * B * 1e-6 * (H_n2o  * exp(2700*(1/(T_c + 273.15) - 1/298.15))))





C_me_ratio <- rep( NA, 1e4 )

for( i in 1:length( C_me_ratio ) ){
C_me_ratio[ i ] <- (1e-6 * B_me[i] * ( V_g_me[i] * ( C_e_me[i] - 0 ) / ( 8.3144598 * ( T_c_me[i] + 273.15 ) * V_w_me[i] ) + H_n2o * exp( 2700 * ( 1 / ( T_c_me[i] + 273.15 ) - 1 / 298.15 ) ) * C_e_me[i] )) /
  (C_a_n2o_me[i] * B_me[i] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_me[i] + 273.15) - 1/298.15)))) 
}


# combine into dataframe for ggplot. qplot, which accepts vectors,
# was deprecated in ggplot 3.4.0
C_ratio_df <- tibble(C_me_ratio = C_me_ratio)

ggplot(C_ratio_df, aes( x = C_me_ratio )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C_ratio , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors") +
  xlab( "saturation ratio")

ggplot(C_ratio_df, aes( x = C_me_ratio - C_ratio )) +  
  geom_histogram( binwidth = 0.001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors") +
  xlab( "absolute error (saturation ratio)")

# standard deviation of a saturation ratio value s:
sd(C_me_ratio) # 0.029

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me_ratio) * 1.96 # +/- 0.0569

# so any ratio within 0.0569 of 1.0 cannot be discerned as a source or sink
```

# Set up model for MIMS

In Membrane Inlet Mass Spectrometry (MIMS), dissolved gases (typically N2, Ar, O2, N2O) are extracted from a water sample as it passes through a semi-permeable membrane. The abundance of the extracted gases are then measured using a quadrapole mass spectrometer. One advantage of this approach relative to the traditional headspace equilibrium method is that dissolved gases are extracted without contamination and/or dilution from a headspace gas (e.g. air, nitrogen, helium). Dilution by a pure gas isn't much of a concern because N2O detection limits are very low via GC, but correction for the presence of N2O in the headspace gas reduces measurement precision.

Dissolved N2O concentration in a MIMS sample can be calculated from the N2O signal strength and a calibration factor. The calibration factor is determined by analyzing a water sample with known N2O concentration. This is most frequently accomplished by equilibrating laboratory water with air at constant temperature, barometric pressure and N2O partial pressure. The dissolved N2O concentration of the equilibrated water is calculated from solubility laws (see [Set up model for simulating true saturation concentration]) and the calibration factor is:

$$N_2O \text{ calibration factor} =\frac{[N_2O_{\text{dissolved standard}}]}{N_2O_{\text{standard}} \text{ signal strength}}$$ 

The N2O concentration of an unknown sample is then calculated as:

$$C = [N_2O_{sample}] = N_2O_{\text{sample}} \text{ signal strength} * N_2O \text{ calibration factor}$$ 

The equation simply scales the concentration of the N2O standard to the ratio of the MIMS signal strength of the unknown and standard. Via substitution and rearrangement, the equation can be written as: 

$$C =[N_2O_{sample}] = \frac{N_2O_{\text{sample}} \text{ signal strength}}{N_2O_{\text{standard}} \text{ signal strength}} * [N_2O_{\text{dissolved standard}}]$$
MIMS provides greater precision when measuring gas ratios as compared to measuring a single gas.  High precision gas ratio data can be converted to concentration data with the independent measurement of concentration of one of the component gases.  N2O:Ar ratios are particularly useful for environmental samples because Ar is biologically inert, therefore its concentration can be calculated from solubility, water temperature, barometric pressure, and atmospheric partial pressure (essentially constant across the globe).  As with single gas measurements, N2O:Ar ratios are converted to N2O concentration using a calibration factor derived from measurement of laboratory water equilibrated with air:
$$N_2O \text{ calibration factor} =\frac{[N_2O:Ar]_{\text{standard}}}{N_2O_{\text{standard}} \text{ signal strength }\text{: }{Ar_{\text{standard}} \text{ signal strength}}}$$ 
The N2O concentration of an unknown sample is then calculated as: 
$$C = [N_2O_{sample}] =  [N_2O_\text{sample} \text{ signal strength : }Ar_\text{sample}\text{signal strength}] * N_2O \text{ calibration factor} * [Ar_{\text{dissolved standard}}]$$
As above, the equation simply scales the N2O:Ar ratio measured in the sample to that of the standard.  Via substitution and rearrangement, the equation can be written as: 
$$C = [N_2O_{sample}] = \frac{\frac{N_2O_{\text{sample}} \text{ signal strength}}{Ar_{\text{sample}} \text{ signal strength}}}{\frac{N_2O_{\text{standard}} \text{ signal strength}}{Ar_{\text{standard}} \text{ signal strength}}} * [N_2O:Ar]_{\text{standard}} * [Ar]_{\text{standard}}$$
Concentration of N2O and Ar in the standard is calculated from temperature of the equilibrated water (T_C_standard), laboratory barometric pressure (B), N2O and Ar partial pressure in the atmosphere (C_a_N2O, C_a_Ar, respectively)(see [Set up model for simulating true saturation concentration]).  By substitution, the equation becomes:
$$C = [N_2O_{sample}] = \frac{\frac{N_2O_{\text{sample}} \text{ signal strength}}{Ar_{\text{sample}} \text{ signal strength}}}{\frac{N_2O_{\text{standard}} \text{ signal strength}}{Ar_{\text{standard}} \text{ signal strength}}} *\frac{ 1^{-6}B*C_{a\text_N2O}*(H_{N2O}*exp(2700* \frac{1}{Tc} -  \frac{1}{298.15}))}{1^{-6}B*C_{a\text_Ar}*(H_{Ar}*exp(1500* \frac{1}{Tc} -  \frac{1}{298.15}))} * 1^{-6}B*C_{a\text_Ar}*(H_{Ar}*exp(1500* \frac{1}{Tc} -  \frac{1}{298.15}))$$
N2O concentration in laboratory air (Ca_N2O) is derived from direct measurement of N2O via gas chromatography and has a standard deviation of `r n2o_sd_epa` using the method employed in this study [Define GC measurement error], although more precise methods are available (see below).  Ar in the lab atmosphere (Ca_Ar) is 9340ppm and is assumed to be constant and perfectly known (e.g. zero error).  Genther et al (2013) report a standard deviation of 0.022 for the N2O:Ar signal strength ratio but Speir et al (2023) report a CV of 0.05% (sd ~ 0.000096). Here we provisionally use the Speir value pending confirmation.  MIMS uses a very precise thermister  (+/-0.01 C) to control the temperature of the water used as the analytical standard (simulated below). Measurement error in B quantified above.



## Simulate measurement error for all observables

```{r simulate_me_pure_gas_all_MIMS, message=F}


n2o_ar_standard_signal <- 0.27 # Speir et al. 0.27 pers comm. Genther et al. section 3.4 reports 0.192
n2o_ar_sample_signal <- 0.23 # just a guess
C_a_ar <- 9340 #ppm.  invariant
T_c_mims <- T_c # set up for simulation of MIMS temperature bath


# this simulates MIMS measurement.
# assume TRUE value is n2o_ar_standard_signal and error is simulated with CV from Speier et al. 2023
# Speier et al reports "...our precision was good among all sample and standard replicated (average CV = 0.05%)."
# Using that CV to model measurement error in the N2O:Ar ratio yields a sd of dissolved N2O that exceeds
# the sd when measured via GC, which is weird.  Speier reported that the CV is for the N2O:Ar ratio.
# Genther et al reports a n2o:Ar sd of 0.022, but this also generated a sd for dissolved N2O which exceeds that 
# measured with GC!  Here we use the Speir data
n2o_ar_signal_sd <- 0.0005 * n2o_ar_standard_signal # sd = CV * mean.  0.05% = 0.0005

n2o_ar_standard_signal_me <- rnorm( 1e4, n2o_ar_standard_signal, n2o_ar_signal_sd ) # me in N2O:Ar of standard  
n2o_ar_sample_signal_me <- rnorm( 1e4, n2o_ar_sample_signal, n2o_ar_signal_sd ) # me in N2O:Ar of sample  


# High precision water batch used to control temperature of standards
T_c_mims_me <- rnorm(1e4, T_c_mims, 0.005) # thermostated bath precision is +/-0.01 Celsius
# hist(T_c_mims_me) # sd of 0.005 gives expected distribution for the specified precision

# True dissolved N2O concentration
C <- ((n2o_ar_sample_signal / n2o_ar_standard_signal) * # N2O:Ar ratios for sample and standard
  ( (1e-6 * B * C_a_n2o * (H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) )) / #N2O concentration in standard
  (1e-6 * B * C_a_ar * (H_ar * exp( 1500 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) )) ) * #Ar concentration in standard
  (1e-6 * B * C_a_ar*(H_ar  * exp(1500 *(1/(T_c + 273.15) - 1/298.15))))) 

C <- C * 1e9 #convert mol to nmol

# variation in measured N2O concentration
C_me <- rep(NA, 1e4)

for( i in 1:length( C_me ) ){
C_me[ i ] <- (n2o_ar_sample_signal_me[ i ] / n2o_ar_standard_signal_me[ i ]) * # N2O:Ar ratios for sample and standard
  ( (1e-6 * B_me[ i ] * C_a_n2o_me[i] * (H_n2o * exp( 2700 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) / #N2O concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar * exp( 1500 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) ) * #Ar concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar  * exp(1500 *(1/(T_c_mims_me[ i ] + 273.15) - 1/298.15)))) 
}


# combine into dataframe for ggplot.
C_me_df <- tibble(C_me = C_me * 1e9)

ggplot(C_me_df, aes( x = C_me)) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to cumulative \nmeasurment errors using MIMS") +
  xlab( "dissolved N2O (nmol L-1)")

ggplot(C_me_df, aes( x = C_me - C )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to cumulative \nmeasurment errors using MIMS") +
  xlab( "absolute error (nmol L-1)")


# standard deviation of dissolved N2O via MIMS:
sd(C_me * 1e9) # 0.169 using Speir CV to calculate N2O:Ar sd.   0.15 with GC and headspace equilibrium!
# CV of dissolved N2O
sd(C_me * 1e9) / mean(C_me * 1e9) # 0.025 = 2.5%  12% using Genther sd.



```
## Simulate measurement error for all observables with improved GC precision

The GC used in the current study is optimized to quantify several analytes across a broad range of concentrations but greater precision can be achieved by optimizing the instrument for a single analyte across a narrower range of concentrations.  For example,  laboratories participating in an international analysis of N2O standards used for atmsopheric monitoring reported a mean standard deviation of `r n2o_sd_lit`, which is 10-fold lower than the standard deviation of N2O measurements in this study (`r n2o_sd_epa`).  Utilizing more precise N2O measurements for the equilibrated headspace and/or air will reduce uncertainty in the estimated dissolved N2O concentration, dissolved N2O equilibrium value, and N2O saturation ratio.

```{r simulate_me_gc_pure_gas_all_MIMS, message=F}
# simulate improved measurement precision of GC measurement of N2O in air
C_a_n2o_lit_me <- rnorm(1e4, C_a_n2o, n2o_sd_lit)

# variation in measured N2O concentration
C_me <- rep(NA, 1e4)

for( i in 1:length( C_me ) ){
C_me[ i ] <- (n2o_ar_sample_signal_me[ i ] / n2o_ar_standard_signal_me[ i ]) * # N2O:Ar ratios for sample and standard
  ( (1e-6 * B_me[ i ] * C_a_n2o_lit_me[i] * (H_n2o * exp( 2700 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) / #N2O concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar * exp( 1500 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) ) * #Ar concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar  * exp(1500 *(1/(T_c_mims_me[ i ] + 273.15) - 1/298.15)))) 
}


# combine into dataframe for ggplot.
C_me_df <- tibble(C_me = C_me * 1e9)

ggplot(C_me_df, aes( x = C_me)) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = C , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to cumulative \nmeasurment errors using MIMS") +
  xlab( "dissolved N2O (nmol L-1)")

ggplot(C_me_df, aes( x = C_me - C )) +  
  geom_histogram( binwidth = 0.01 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in dissolved N2O concentration due to cumulative \nmeasurment errors using MIMS") +
  xlab( "absolute error (nmol L-1)")


# standard deviation of dissolved N2O via MIMS:
sd(C_me * 1e9) # 0.0168 using Speir CV to calculate N2O:Ar sd. 0.15 with GC and headspace equilibrium!

# CV of dissolved N2O
sd(C_me * 1e9) / mean(C_me * 1e9) # 0.002 = 0.25% CV 



```

## Simulate ratio with MIMS and standard GC
```{r simulate_me_ratio_pure_gas_all_MIMS, message=F}
# True ratio
C_ratio <- ((n2o_ar_sample_signal / n2o_ar_standard_signal) * # N2O:Ar ratios for sample and standard
  ( (1e-6 * B * C_a_n2o * (H_n2o * exp( 2700 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) )) / #N2O concentration in standard
  (1e-6 * B * C_a_ar * (H_ar * exp( 1500 * ( 1 / ( T_c + 273.15 ) - 1 / 298.15 ) ) )) ) * #Ar concentration in standard
  (1e-6 * B * C_a_ar*(H_ar  * exp(1500 *(1/(T_c + 273.15) - 1/298.15))))) / # Ar concentration in standard
  (C_a_n2o * B * 1e-6 * (H_n2o  * exp(2700*(1/(T_c + 273.15) - 1/298.15)))) # N2o saturation value in waterbody 



C_me_ratio <- rep( NA, 1e4 )

for( i in 1:length( C_me_ratio ) ){
C_me_ratio[ i ] <- (n2o_ar_sample_signal_me[ i ] / n2o_ar_standard_signal_me[ i ]) * # N2O:Ar ratios for sample and standard
  ( (1e-6 * B_me[ i ] * C_a_n2o_me[ i ] * (H_n2o * exp( 2700 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) / #N2O concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar * exp( 1500 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) ) * #Ar concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar  * exp(1500 *(1/(T_c_mims_me[ i ] + 273.15) - 1/298.15)))) / # Ar concentration in standard 
  (C_a_n2o_me[ i ] * B_me[ i ] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_me[ i ] + 273.15) - 1/298.15)))) # N2o saturation value in waterbody 
}


# combine into dataframe for ggplot.
C_ratio_df <- tibble(C_me_ratio = C_me_ratio)

ggplot(C_ratio_df, aes( x = C_me_ratio )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = C_ratio , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors using MIMS and standard GC analytics") +
  xlab( "saturation ratio")

ggplot(C_ratio_df, aes( x = C_me_ratio - C_ratio )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors using MIMS and standard GC analytics") +
  xlab( "absolute error (saturation ratio)")



# standard deviation of a saturation ratio value s:
sd(C_me_ratio) # 0.0011

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me_ratio) * 1.96 # +/- 0.00216

# so any ratio within 0.00216 of 1.0 cannot be discerned as a source or sink



```



## Simulate ratio with MIMS and high precision GC
```{r simulate_me_ratio_gc_pure_gas_all_MIMS, message=F}

C_me_ratio <- rep( NA, 1e4 )

for( i in 1:length( C_me_ratio ) ){
C_me_ratio[ i ] <- (n2o_ar_sample_signal_me[ i ] / n2o_ar_standard_signal_me[ i ]) * # N2O:Ar ratios for sample and standard
  ( (1e-6 * B_me[ i ] * C_a_n2o_lit_me[ i ] * (H_n2o * exp( 2700 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) / #N2O concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar * exp( 1500 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) ) * #Ar concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar  * exp(1500 *(1/(T_c_mims_me[ i ] + 273.15) - 1/298.15)))) / # Ar concentration in standard 
  (C_a_n2o_lit_me[ i ] * B_me[ i ] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_me[ i ] + 273.15) - 1/298.15)))) # N2o saturation value in waterbody 
}


# combine into dataframe for ggplot.
C_ratio_df <- tibble(C_me_ratio = C_me_ratio)

ggplot(C_ratio_df, aes( x = C_me_ratio )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = C_ratio , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors using MIMS and high precision GC analytics") +
  xlab( "saturation ratio")

ggplot(C_ratio_df, aes( x = C_me_ratio - C_ratio )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors using MIMS and standard GC analytics") +
  xlab( "absolute error (saturation ratio)")



# standard deviation of a saturation ratio value s:
sd(C_me_ratio) # 0.0011

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me_ratio) * 1.96 # +/- 0.00216

# so any ratio within 0.00216 of 1.0 cannot be discerned as a source or sink



```

## Simulate ratio with MIMS, high precision GC, and high precision temperature in field

The thermometers used to measure water temperature in this study have an uncertainty of +/- 0.058C but electronic thermisters are commonly available (e.g. YSI sondes) with an uncertainty of +/-0.01 Celsius.  More precise water temperature measurements will reduce uncertainty in the equilibrium N2O conentration and the saturation ratio.
```{r simulate_me_ratio_gc_temp_all_MIMS, message=F}

C_me_ratio <- rep( NA, 1e4 )

for( i in 1:length( C_me_ratio ) ){
C_me_ratio[ i ] <- (n2o_ar_sample_signal_me[ i ] / n2o_ar_standard_signal_me[ i ]) * # N2O:Ar ratios for sample and standard
  ( (1e-6 * B_me[ i ] * C_a_n2o_lit_me[ i ] * (H_n2o * exp( 2700 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) / #N2O concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar * exp( 1500 * ( 1 / ( T_c_mims_me[ i ] + 273.15 ) - 1 / 298.15 ) ) )) ) * #Ar concentration in standard
  (1e-6 * B_me[ i ] * C_a_ar * (H_ar  * exp(1500 *(1/(T_c_mims_me[ i ] + 273.15) - 1/298.15)))) / # Ar concentration in standard 
  (C_a_n2o_lit_me[ i ] * B_me[ i ] * 1e-6 * (H_n2o  * exp(2700*(1/(T_c_mims_me[ i ] + 273.15) - 1/298.15)))) # N2o saturation value in waterbody 
}


# combine into dataframe for ggplot.
C_ratio_df <- tibble(C_me_ratio = C_me_ratio)

ggplot(C_ratio_df, aes( x = C_me_ratio )) +  
  geom_histogram( binwidth = 0.0001 ) + 
  geom_vline( xintercept = C_ratio , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors using MIMS, high precision GC analytics, and high precision \nin situ temperature measurements") +
  xlab( "saturation ratio")

ggplot(C_ratio_df, aes( x = C_me_ratio - C_ratio )) +  
  geom_histogram( binwidth = 0.00001 ) + 
  geom_vline( xintercept = 0 , color = 'red' ) + 
  ggtitle( "Uncertainty in N2O saturation ratio due to cumulative \nmeasurment errors using MIMS, high precision GC analytics, and high precision \nin situ temperature measurements") +
  xlab( "absolute error (saturation ratio)")



# standard deviation of a saturation ratio value s:
sd(C_me_ratio) # 0.0006603624

# the 95% CI is therefore the computed value +/- 2 standard deviations
sd(C_me_ratio) * 1.96 # +/- 0.00129431

# so any ratio within 0.00129 of 1.0 cannot be discerned as a source or sink



```
# Summary of results

Precision of the N2O saturation ratio can be improved using high precision GC analytics and N2O-free headspace gas (e.g. helium, nitrogen) but the greatest improvement is seen when dissolved N2O is directly measured using MIMS.
```{r final_figure, message=FALSE}

results <- tibble(ratio_sd = c(0.055,
                               0.048,
                               0.029,
                               0.001207747,
                               0.001207747,
                               0.000690139),
                  method = c("GC",
                             "GC + helium",
                             "High precision GC + helium",
                             "MIMS",
                             "MIMS + high precision GC",
                             "MIMS + high precision GC + \nhigh precision water temp"))


results %>%
  mutate(lower.95 = C_ratio - (1.96 * ratio_sd),
         upper.95 = C_ratio + (1.96 * ratio_sd),
         C_ratio = C_ratio) %>%
  ggplot(aes(C_ratio, method)) +
  geom_point() +
  geom_segment(aes(x=lower.95, xend = upper.95, y=method, yend=method)) +
  xlab("True saturation ratio (black dot) and 95% confidence interval") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust = 1))

```
