---
title: "MRP with NLA 2017 $N_2O$ Data"
author: "Roy Martin, Jake Beaulieu, Michael McManus"
date: "`r Sys.Date()`"
output:
  html_notebook: 
    toc: yes
    toc_depth: 4
    toc_float: true
    code_folding: show
    font_size: 14
    number_sections: true
    theme: simplex
bibliography: RWM_Endnote_Library.bib
link-citations: yes
---
# Setup R
```{r load_packages, message=FALSE, warning=FALSE}
library(brms)
library(bayesplot)
library(kableExtra)
library(tidyverse)
library(ggplot2)
library(ggExtra)
library(gridExtra)
library(tidybayes)
library(ggrepel)

options(mc.cores = parallel::detectCores(logical = FALSE))
options( max.print = 2000 )
```

```{r utility_functions, include=FALSE}
# Identify local path for each user
localPath <- Sys.getenv("USERPROFILE")

# Define helper functions
# standardized formatting for column names
toEPA <- function(X1){
  names(X1) = tolower(names(X1))
  names(X1) = gsub(pattern = c("\\(| |#|)|/|-|\\+|:|_"), replacement = ".", x = names(X1))
  X1
}

#Calc geometric mean
gm_mean = function(x, na.rm=TRUE, zero.propagate = FALSE){
  if(any(x < 0, na.rm = TRUE)){
    return(NaN)
  }
  if(zero.propagate){
    if(any(x == 0, na.rm = TRUE)){
      return(0)
    }
    exp(mean(log(x), na.rm = na.rm))
  } else {
    exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
  }
}

gm_sd = function(x, na.rm=TRUE, zero.propagate = FALSE){
  if(any(x < 0, na.rm = TRUE)){
    return(NaN)
  }
  if(zero.propagate){
    if(any(x == 0, na.rm = TRUE)){
      return(0)
    }
    exp(sd(log(x), na.rm = na.rm))
  } else {
    exp(sd(log(x[x > 0]), na.rm=na.rm) / length(x))
  }
}

#calculate skew
skew <- function(x) {
  xdev <- x - mean(x)
  n <- length(x)
  r <- sum(xdev^3) / sum(xdev^2)^1.5
  return(r * sqrt(n) * (1 - 1/n)^1.5)
 }
```

# Background
In this document we use multilevel regression with post-stratification (MRP) to adjust population estimates of dissolved N2O gas concentration derived from sample data from the 2017 National Lakes Assessment (NLA).

As explained in the related document,
(https://github.com/USEPA/DissolvedGasNla/blob/master/scripts/dgIndicatorAnalysis.html), duplicate gas samples were collected at a depth of ~0.1$\text{m}$ at designated index sites distributed across 1091 waterbodies nationwide, of which 95 were sampled twice. Gas samples were analyzed via gas chromotography and concentrations were recorded to the nearest 0.001 nmol/L.

The data were collected under a stratified, unequal probability design. The observations can be thought of as hierarchically organized, such that each sample ($n \in n=1,...,N = 1185$) was situated within an index water body ($i \in i=1,...,I = 1091$), which were selected, with unequal probability from different size categories ($l \in l=1,...,L = 5$; < 4$\text{ha}$, 4-10$\text{ha}$, 10-20$\text{ha}$, 20-50$\text{ha}$, and >50$\text{ha}$), within a state ($k \in k=1,...,K = 48$), and an aggregated, Omernik ecoregion ($j \in j=1,...,J = 9$). All 9 ecoregions were represented in the sample, including Xeric (XER), Western Mountain (WMT),  Northern Plains (NPL), Southern Plains (SPL), Temperate Plains (TPL), Coastal Plains (CPL), Upper Midwest (UMW), Northern Appalachian (NAP), and Southern Appalachian (SAP) regions.

# Data
The first step is to read in the .RData file containing the observations, previously munged here: 
https://github.com/USEPA/DissolvedGasNla/blob/master/scripts/dataMunge.html

```{r import_data, eval=FALSE, include=TRUE}
load( file = paste0( localPath,
              "/Environmental Protection Agency (EPA)/",
              "ORD NLA17 Dissolved Gas - Documents/",
              "inputData/dg.2021-02-01.RData")
      )

save(dg, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/dg.rda") 
```

## Observational data
The next step involves creating a new dataframe object including only variables of interest for this modeling exercise: the dissolved N2O observations; the design variables indexed to the observations; and the NO3 covariate observations. This step also includes: renaming some of these variables for convenience; rounding observations to the stated measurement precision above; and recoding the left-censored NO3 covariate in two different ways. The first treats the left-censored data as continuous, assigning to observations below the noted detection limit a value of 1/2 the limit. The second converts the NO3 data to an ordered factor. 
```{r mod1_data_import, paged.print=TRUE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/dg.rda")

# number of observations before filtering probability samples
dg %>%
  filter(!is.na(dissolved.n2o.nmol)) %>% # remove obs with missing response measurements
  nrow()

df_model <- dg %>%
  filter(!is.na(dissolved.n2o.nmol)) %>%
  filter(sitetype == "PROB") %>% # probability samples only
  filter(visit.no == 1) %>%
  mutate(n2o = dissolved.n2o.nmol,
         n2o_eq = sat.n2o.nmol,
         n2o_sat = n2o.sat.ratio,
         n2o_em = e.n2o.nmol.d,
         n2o_flux = f.n2o.m.d,
         WSA9 = factor(ag.eco9),
         state = factor(state.abb[match(state.nm, state.name)]),
         size_cat = recode(area.cat6, 
                           "(1,4]" = "min_4" ,
                           "(10,20]" = "10_20",
                           "(20,50]" = "20_50",
                           "(4,10]" = "4_10",
                           ">50" = "50_max")) %>%
  mutate(size_cat = factor(size_cat,
                           levels = c("min_4", "4_10", "10_20", "20_50", "50_max"),
                           ordered = TRUE)) %>%
  mutate(no3 = ifelse(nitrate.n.result <= 0.005, 0.01, round(nitrate.n.result, 2))) %>% # 1/2 mdl
  mutate(no3_mis = ifelse( nitrate.n.result < 0.02, -1, 0)) %>%
  #mutate(no3_cat = cut(lognitrate.n.result, 
  #                     breaks = c(-Inf, 0.01, 0.05, 0.1, 0.25, 0.5, 1.0, Inf),
  #                     labels = c("1", "2", "3", "4", "5", "6", "7"))) %>%
  #                     #breaks = c(-Inf, 0.01, 0.10, 0.2, 0.5, Inf),
  #                     #labels = c("vL", "L", "M", "H", "vH"))) %>%
  mutate(no3_cat = cut(log(no3), 
                       breaks = c(-Inf, -4, -3, -2, -1, 1.0, Inf),
                       labels = c("1", "2", "3", "4", "5", "6"))) %>%
                       #breaks = c(-Inf, 0.01, 0.10, 0.2, 0.5, Inf),
                       #labels = c("vL", "L", "M", "H", "vH"))) %>%
  mutate(no3_cat = factor(no3_cat,
                          levels = c("1", "2", "3", "4", "5", "6"),
                          ordered = TRUE)) %>%
  select(WSA9,
         state,
         size_cat,
         n2o,
         n2o_eq,
         n2o_sat,
         n2o_em,
         n2o_flux,
         no3,
         no3_mis,
         no3_cat
         )

save(df_model, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda") 

nrow(df_model) # number of obs after filtering for probability samples and removing one site missing ecoregion (WSA9) info.
print(df_model)
```

## Population data
The next step is to import the sample frame, which will be used in the post-stratification step to adjust the sample inferences to the population of interest.
```{r import_sample_frame, eval=FALSE, include=TRUE}
sframe <- read.csv( file = paste0( localPath,
              "/Environmental Protection Agency (EPA)/",
              "ORD NLA17 Dissolved Gas - Documents/",
              "inputData/NLA_Sample_Frame.csv" ), header = T )

sframe <- sframe %>%
  filter(nla17_sf != "Exclude2017") %>%
  filter(nla17_sf != "Exclude2017_Include2017NH") %>%
  mutate(WSA9 = factor(ag_eco9),
          state = factor(state),
          size_cat = factor(area_cat6)) %>% 
  select(WSA9, state, size_cat, area_ha, perim_km) %>% 
  filter(state != "DC") %>%
  filter(state != "HI") %>%
  droplevels() %>%
  mutate(WSA9 = fct_drop(WSA9)) %>% # remove NA level
  #filter( size_cat != "(0,1]" ) %>%
  mutate(size_cat = recode(size_cat, 
                           "(1,4]" = "min_4" ,
                           "(10,20]" = "10_20",
                           "(20,50]" = "20_50",
                           "(4,10]" = "4_10",
                           ">50" = "50_max")) %>%
  mutate(size_cat = factor(size_cat, 
                           levels = c("min_4", "4_10", "10_20", "20_50", "50_max"),
                           ordered = TRUE))

save(sframe, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/sframe.rda") 

print(sframe)
```

Next, filter and select the frame down to only the observations and design variables needed for post-stratification. Some of the variables are again renamed to match the naming conventions used in the observational data above. DC and HI are also filtered out because the population of interest includes only the lower 48 states.

The post-stratification cells are summarized next.
```{r filter_frame, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/sframe.rda")

pframe <- sframe %>%
  select(WSA9, state, size_cat) %>% 
  mutate( obs = 1 ) %>%
  group_by( WSA9, state, size_cat ) %>%
  summarise( n_cell = sum( obs ) ) %>%
  ungroup() %>%
  mutate(prop_cell = n_cell/sum(n_cell)) %>%
  mutate(type = "population") 

save(pframe, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")

print(pframe)
```
Above there are 536 rows indicating that, with respect to the probabilistic sampling design based on ecoregion (WSA9), state, and size category, there are 536 types of sites in the population of interest; and the counts and proportions of those types relative to the population are indicated for each row.

## Sample vs. population
The cell distributions in the population of interest are compared to the proportions in the sample below.
```{r sample_cell_counts, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

samp_props <- df_model %>%
  mutate(obs = 1) %>%
  group_by(WSA9, state, size_cat) %>%
  summarize(n_cell = sum(obs)) %>%
  ungroup() %>%
  mutate(prop_cell = round(n_cell / sum(n_cell), 7)) %>%
  mutate(type = "sample") 

save(samp_props, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props.rda")

print(samp_props)
```
Above, it is show that there are 352 site types (rows) in the sample compared to 536 in the population. The multilevel model will enable inferences to the missing types.

Below is a graphical comparison of the distribution of cells in the population of interest vs. the sample.
```{r compare_sample_pop_cells, echo=FALSE, fig.align='center', fig.height=4, fig.width=10}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props.rda")

pframe %>%
  bind_rows(samp_props) %>%
  ggplot(aes(x = interaction(WSA9, state, size_cat), y = prop_cell, group = type, linetype = type)) +
  geom_point(stat = "identity", aes( shape = type, color = type)) +
  geom_line() +
  theme_tidybayes() +
  theme(axis.text.x = element_blank()) +
  xlab("WSA9:state:size") +
  ylab("proportion in cell")
```
In the above graphic, it can be seen that the sample proportions don't match the proportions in the population of interest. This was by design, since this was a stratified probabilistic sample. 

Below is a comparison of population vs. sample distributions by ecoregion.
```{r eco_props_pop, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")

pframe_eco <- pframe %>%
  group_by(WSA9) %>%
  summarise(n_cell = sum(n_cell)) %>%
  ungroup() %>%
  mutate(prop_cell = round(n_cell/sum(n_cell), 7)) %>%
  ungroup() %>%
  mutate(type = 'population') 

save(pframe_eco, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe_eco.rda")
```

```{r eco_props_sample, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props.rda")

samp_props_eco <- samp_props %>%
  group_by(WSA9) %>%
  summarise(n_cell = sum(n_cell)) %>%
  ungroup() %>%
  mutate(prop_cell = round(n_cell/sum(n_cell), 7)) %>%
  ungroup() %>%
  mutate(type = 'sample')

save(samp_props_eco, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props_eco.rda")
```

```{r compare_eco_sample_pop_cells, echo=FALSE, fig.align='center', fig.height=4, fig.width=6}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe_eco.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props_eco.rda")

pframe_eco %>%
  bind_rows(samp_props_eco) %>%
  ggplot(mapping = aes(x = WSA9, y = prop_cell, group = type, linetype = type)) +
  geom_point(stat = "identity", aes( shape = type, color = type), size = 3) +
  geom_line() +
  theme_tidybayes() +
  xlab("Ecoregion") +
  ylab("proportion in cell") + 
  theme(legend.position = "top",
        legend.title = element_blank(),
        legend.text = element_text(size = 14)) +
  theme(text = element_text(size = 12))
```
The graphic above clearly indicates undersampling in the CPL relative to the population and oversampling in the WMT and XER ecoregions. 

The comparison can also be done by state.
```{r state_props_pop, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")

pframe_state <- pframe %>%
  group_by(state) %>%
  summarise(n_cell = sum(n_cell)) %>%
  ungroup() %>%
  mutate(prop_cell = round(n_cell/sum(n_cell), 7)) %>%
  ungroup() %>%
  mutate(type = 'population')

save(pframe_state, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe_state.rda")
```

```{r state_props_sample, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props.rda")

samp_props_state <- samp_props %>%
  group_by(state) %>%
  summarise(n_cell = sum(n_cell)) %>%
  ungroup() %>%
  mutate(prop_cell = round(n_cell/sum(n_cell), 7)) %>%
  ungroup() %>%
  mutate(type = 'sample')

save(samp_props_state, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props_state.rda")
```

```{r compare_state_sample_pop_cells, echo=FALSE, fig.align='center', fig.height=4, fig.width=10}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe_state.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props_state.rda")

pframe_state %>%
  bind_rows(samp_props_state) %>%
  ggplot(mapping = aes(x = state, y = prop_cell, group = type, linetype = type)) +
  geom_point(stat = "identity", aes(shape = type, color = type)) +
  geom_line() +
  theme_tidybayes() +
  theme(axis.text.x = element_text(angle = 45)) +
  xlab("State") +
  ylab("proportion in cell")
```
The graphic above indicates clear undersampling, relative to the population of interest, in some states and oversampling in others.

The comparison by size class is next.
```{r size_props_pop, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")

pframe_size <- pframe %>%
  group_by(size_cat) %>%
  summarise(n_cell = sum(n_cell)) %>%
  ungroup() %>%
  mutate(prop_cell = round(n_cell/sum(n_cell), 7)) %>%
  ungroup() %>%
  mutate(type = 'population')

save(pframe_size, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe_size.rda")
```

```{r size_props_sample, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props.rda")

samp_props_size <- samp_props %>%
  group_by(size_cat) %>%
  summarise(n_cell = sum(n_cell)) %>%
  ungroup() %>%
  mutate(prop_cell = round(n_cell/sum(n_cell), 7)) %>%
  ungroup() %>%
  mutate(type = 'sample')

save(samp_props_size, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props_size.rda")
```

```{r compare_size_sample_pop_cells, echo=FALSE, fig.align='center', fig.height=4, fig.width=6}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe_size.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/samp_props_size.rda")

pframe_size %>%
  bind_rows(samp_props_size) %>%
  ggplot(mapping = aes(x = size_cat, y = prop_cell, group = type, linetype = type)) +
  geom_point(stat = "identity", aes( shape = type, color = type)) +
  geom_line() +
  theme_tidybayes() +
  xlab("Size category") +
  ylab("proportion in cell")
```
Clearly, small streams were undersampled relative to the population of interest; and larger streams were oversampled.

## Sample-based estimates
Naive estimates using the sample for inference about the population of interest are presented below. First, the overall mean and standard deviation for N2O in the sample.
```{r sample_summary}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  summarise(mean = mean(n2o),
             sd = sd(n2o)) %>%
  print()
```

Next, a plot of the overall mean (dashed line) and ecoregion-specific means (black circles) based only on the sample. The shaded areas represent +/- 1 standard deviation.
```{r sample_summary_eco, echo=FALSE, fig.align='center', fig.height=4, fig.width=6, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  group_by(WSA9) %>%
  summarise(mean = mean( n2o),
             sd = sd( n2o)) %>%
  ggplot(aes(x = WSA9, y = mean, group = 1)) +
  geom_ribbon(aes(ymin = mean - sd, ymax = mean + sd, x = WSA9), fill = 'lightgrey', alpha = .7)+
  geom_line(aes(x = WSA9, y = mean))+
  geom_point()+
  geom_hline(yintercept = 8.72, linetype = 'dashed') +
  theme_tidybayes() + 
  xlab("Ecoregion") +
  ylab("Sample mean")
```
The same summary by state is below.
```{r sample_summary_state, echo=FALSE, fig.align='center', fig.height=4, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  group_by(state) %>%
  summarise(mean = mean(n2o),
             sd = sd(n2o)) %>%
  ggplot(aes(x = state, y = mean, group = 1)) +
  geom_ribbon(aes(ymin = mean - sd, ymax = mean + sd, x = state), fill = 'lightgrey', alpha = .7)+
  geom_line(aes(x = state, y = mean))+
  geom_point()+
  geom_hline(yintercept = 8.72, linetype = 'dashed') +
  theme_tidybayes() +
  theme(axis.text.x = element_text( angle = 45)) +
  xlab("State") +
  ylab("Sample mean")
```
And finally by size class.
```{r sample_summary_size, echo=FALSE, fig.align='center', fig.height=4, fig.width=6, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  group_by(size_cat) %>%
  summarise(mean = mean(n2o),
             sd = sd(n2o)) %>%
  ggplot(aes(x = size_cat, y = mean, group = 1)) +
  geom_ribbon(aes(ymin = mean - sd, ymax = mean + sd, x = size_cat), fill = 'lightgrey', alpha = .7)+
  geom_line(aes(x = size_cat, y = mean))+
  geom_point()+
  geom_hline(yintercept = 8.72, linetype = 'dashed') +
  theme_tidybayes() +
  theme(axis.text.x = element_text(angle = 45)) +
  xlab("Size category") +
  ylab("Sample mean")
```

## Additional graphical exploration
Below, the N2O observations are graphed according to the survey design factors. First, a plot of log(N2O) by WSA9 ecoregion.
```{r summary_N2O_vs_ecoregion, echo=FALSE, fig.align='center', fig.height=10, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = WSA9, y = log(n2o), group = WSA9, color = WSA9)) +
  geom_boxplot(outlier.shape = NA, color = "black" ,alpha = 0.7) + 
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  theme(text = element_text(size=12)) +
  coord_flip() +
  theme_bw()
```
Note the strong right-skew in the figure above, even with the N2O observations presented on the natural log scale. There is also some left-skew. Environmental concentrations and N2O, in particular, are typically modeled according to a lognormal or Gamma data generating process [e.g., @Webb_etal_2019]; however, the right tails associated with these N2O observations could prove tough to replicate even with a data generating process enforcing multiplicative errors.

Next, a plot of log(N2O) by states in ecoregions. Note that interacting state and ecoregion (i.e., state:ecoregion) reflects the nested nature of the data. That is, each ecoregion does not contain every state. Thus, state is nested in ecoregion.
```{r summary_N2O_vs_state, echo=FALSE, fig.align='center', fig.height=10, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = WSA9:state, y = log(n2o), group = WSA9:state, color = WSA9:state)) +
  geom_boxplot(outlier.shape = NA, color = "black" ,alpha = 0.7) + 
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  theme(text = element_text(size=12)) +
  coord_flip() +
  theme_bw()
```
In the figure above, strong left and right skew in log(N2O) remain. Both the means and variances may vary by grouping.

Next, a plot of size categories in each state in each ecoregion. Size category is also nested in state and ecoregion, since not every ecoregion:state grouping contains all size classes of lakes.  
```{r summary_N2O_vs_all, echo=FALSE, fig.align='center', fig.height=14, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = WSA9:state:size_cat, y = log(n2o), group = WSA9:state:size_cat, color = WSA9:state:size_cat)) +
  geom_boxplot(outlier.shape = NA, color = "black" ,alpha = 0.7) + 
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  theme(axis.text.y = element_blank()) +
  coord_flip()
```
In the figure above, the axis labels containing the ecoregion:state:size labels have been removed because the labels are messy and unecessary to convey the primary message: some clear skew remains in log(N2O) after considering all of the design factors. Again, the means and variances appear likely to differ across groupings.

Next, a look at NO3 vs. the survey variables under the assumption that wide variation in NO3 may be driving some of the skew in the N2O distributions. The first boxplot below shows just log(NO3), where NO3 observations below the detection limit have been replaced with a value 1/2 the detection limit.
```{r summary_NO3_vs_ecoregion, echo=FALSE, fig.align='center', fig.height=10, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = WSA9, y = log(no3), group = WSA9, color = WSA9)) +
  geom_boxplot(outlier.shape = NA, color = "black" ,alpha = 0.7) + 
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  theme(text = element_text(size=12)) +
  coord_flip() +
  theme_bw()
```
Note, above, the wide and skewed variation in log(NO3).

Next, a plot of log(N2O) vs. log(NO3).
```{r summary_N2O_vs_NO3, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = log(no3), y = log(n2o))) +
  geom_point(show.legend = F) +
  geom_smooth(method = "lm") +
  theme(text = element_text(size=12)) +
  theme_bw()
```

Next, a plot of log(N2O) vs. log(NO3) by ecoregion.
```{r summary_N2O_vs_NO3_ecoregion, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = log(no3), y = log(n2o), group = WSA9, color = WSA9)) +
  geom_point(show.legend = F) +
  geom_smooth(method = "lm") +
  facet_wrap(~ WSA9) +
  theme(text = element_text(size=12)) +
  theme_bw()
```
The above scatterplots indicate consistent, positive, linear associations between log(N2O) and log(NO3). The slope of the trend may also vary according to ecoregion. Note also the left bounds on log(no3) due to the left-censored nature of that variable. This figure suggests that NO3 could be a useful covariate to use in the multilevel regression model to help account for potential overdispersion (i.e., unmodeled variability in log(N2O)). 

Similar plots are shown below, but with NO3 expressed as an ordered categorical variable with 6 levels.
```{r summary_N2O_vs_NO3cat, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = no3_cat, y = log(n2o), color = 1)) +
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  geom_boxplot(outlier.shape = NA, color = "black" ,alpha = 0.7) +
  theme(text = element_text(size=12)) +
  theme_bw()
```

```{r summary_N2O_vs_NO3cat_ecoregion, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = no3_cat, y = log(n2o), color = 1)) +
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  geom_boxplot(aes(x = no3_cat, y = log(n2o)), 
               outlier.shape = NA, color = "black" ,alpha = 0.7) + 
  facet_wrap(~ WSA9) +
  theme(text = element_text(size=12)) +
  theme_bw()
```
The trend is still apparent with the ordered categorical version of NO3.

Below, similar plots are shown for log(N2O) vs. lake size category.
```{r summary_N2O_vs_size, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = size_cat, y = log(n2o), color = 1)) +
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  geom_boxplot(outlier.shape = NA, color = "black" ,alpha = 0.7) + 
  theme(text = element_text(size=12)) +
  theme_bw()
```

```{r summary_N2O_vs_size_ecoregion, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

df_model %>%
  ggplot(aes(x = size_cat, y = log(n2o), color = 1)) +
  geom_point( position = position_jitterdodge(), show.legend = F ) +
  geom_boxplot(outlier.shape = NA, color = "black" ,alpha = 0.7) + 
  facet_wrap(~ WSA9) +
  theme(text = element_text(size=12)) +
  theme_bw()
```
In the two figures above, if there is any relationship between log(N2O) and size category, it appears likely to swamped by variation in log(N2O).

# Executing MRP
The survey had sampling bias by design, so the sample-based inferences above are also likely biased with respect to the population of interest. Therefore, the estimates should be adjusted to minimize inferential bias. To do that, a regression model can be fit to the observations to estimate expectations conditional on the design variables. Then, the resulting estimates can be adjusted based on the cell weighting in the population of interest [@Gelman_etal_2020 Ch. 17]. 

With a Bayesian multilevel regression model [e.g., @Gelman_etal_2014; @Gelman_etal_2020; @McElreath_2020], uncertainties are naturally propagated through the post-stratification step. A multilevel/hierarchical regression model also enables partial pooling of information across the groupings, which can regularize estimates and lead to more robust out-of-sample inferences. The degree of regularization itself is conditional on the observed data, influenced by both the size of the data (i.e., number of groupings and number of observations within each group) and the observed variation within and between groups. The multilevel model also lends itself naturally to estimates for missing groups. Recall from the summaries above that only 352 of the 536 cell types in the target population were represented in the sample. The missing cells are readily estimated using the multilevel parameterization because unobserved/missing levels of such hierarchical groupings above the observation level (e.g., a missing ecoregion) are treated as replicates from a defined population with its own distributional parameters (e.g., hierarchical mean and variance terms) that are estimated from the data. Thus, expectations and uncertainties for the unobserved levels are directly defined by the model. Estimates for missing poststratification cells is much less straightforward with a traditional "fixed effects" parameterization, which treats the individual levels of a grouping factor as independent with infinite group-level variance. 

## Fitting a model
The first model estimates N2O concentration in a sample conditional on only the design factors.

### Model 1
```{r n2o_mod_mv_1, eval=FALSE, include=TRUE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

bf_n2o <- bf(n2o ~ (1 | WSA9) + (1 | WSA9:state) + (1 | WSA9:state:size_cat),
             family = Gamma(link = "log"))
n2o_mod1 <- brm(bf_n2o,
                data = df_model, 
                prior = c(
                  prior(normal(2, 1), class = "Intercept"),
                  prior(normal(0, 0.5), class = "sd"),
                  prior(gamma(0.1, 0.1), class = "shape")
                  ),
  control = list(adapt_delta = 0.99, max_treedepth = 14),
  #sample_prior = "only",
  save_pars = save_pars(all = TRUE),
  seed = 86541,
  chains=4, 
  iter=2000, 
  cores=4)

save(n2o_mod1, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod1.rda")
```

#### Summarize fit
We call a summary of the fitted parameters.

```{r print_mod1, echo=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod1.rda")

print(n2o_mod1, prior = T)
```

#### Model checks
A quick posterior predictive check to ensure the fit is a reasonable approximation of the true data generating process.

```{r ppc_dens_overlay_mod_n2o1, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.width=4, fig.height=4}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod1.rda")
pp_check(n2o_mod1, type = "dens_overlay", nsamples = 100, cores = 1) + 
  theme_tidybayes() + xlim(0, 50) + xlab(expression(paste("N"[2],"O"))) + ylab("density")
```
In the figure above, replicated datasets (n = 100) from the fitted model are shown as blue lines, indicating the estimated density curve for each dataset. The black line is a density estimate for the observed dataset. Clearly the model replicates don't closely resemble the observed dataset. The fitted model generates datasets with much broader density and a lighter right tail. The observed data are much more concentrated between 0 and 10 mg/L N2O, and have a much longer right tail. The model is not capturing some important details about the observed data. In the next model below, more structure is introduced in an attempt to better capture the variation in the observations. 

### Model 2
In the next model, a distributional term is included. This is a model specifying potential heterogeneous variances due to the design factors. As seen in the graphical exploration in the previous section, both the mean and variance of log(N2O) look to potentially vary by the survey factors.
```{r n2o_mod_mv_2, eval=FALSE, include=TRUE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

bf_n2o <- bf(n2o ~ (1 | WSA9) + (1 | WSA9:state) + (1 | WSA9:state:size_cat),
             shape ~ (1 | WSA9) + (1 | WSA9:state),
             family = Gamma(link = "log"))
n2o_mod2 <- brm(bf_n2o,
                data = df_model, 
                prior = c(
                  prior(normal(1.9, 0.5), class = "Intercept"),
                  prior(normal(0, 1), class = "sd"),
                  prior(normal(0, 1), class = "sd", dpar= "shape")
                  ),
  #control = list(adapt_delta = 0.90, max_treedepth = 12),
  #sample_prior = "only",
  save_pars = save_pars(all = TRUE),
  seed = 8531,
  chains=4, 
  iter=3000, 
  cores=4)

save(n2o_mod2, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod2.rda")
```

### Model 2

```{r n2o_mod_mv_2, eval=FALSE, include=TRUE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

bf_n2o <- bf(n2o ~ mo(no3_cat) + mo(size_cat) +
               (mo(no3_cat) | a | WSA9) +
               (1 | b | WSA9:state) +
               (1 | c | WSA9:state:size_cat),
             shape ~ mo(no3_cat) +
               (1 | a | WSA9) +
               (1 | b | WSA9:state),
             family = Gamma(link = "log"))
bf_n2oeq <- bf(n2o_eq ~ 1 +
               (1 | a | WSA9) +
               (1 | b | WSA9:state) +
               (1 | c | WSA9:state:size_cat),
               shape ~ (1 | a | WSA9) +
               (1 | b | WSA9:state),
               family = Gamma(link = "log"))
bf_no3 <- bf(no3_cat ~ mo(size_cat) + 
               (1 | a | WSA9) +
               (1 | b | WSA9:state) +
               (1 | c | WSA9:state:size_cat),
             family = cumulative(link = "logit", threshold="flexible"))

n2o_mod <- brm(bf_n2o + 
                 bf_n2oeq + 
                 bf_no3 + 
                 set_rescor(FALSE),
  data = df_model, 
  prior = c(
      prior(normal(1.9, 0.5), class = "Intercept", resp ="n2o"),
      prior(normal(1.9, 0.5), class = "Intercept", resp = "n2oeq"),
      prior(normal(0, 2.5), class = "Intercept", resp = "no3cat"),
      
      #prior(normal(-1, 2), class = "Intercept", dpar = "sigma", resp = "n2o"),
      #prior(normal(0, 3), class = "Intercept", dpar = "shape", resp = "n2o"),
      
      #prior(normal(0, 1), class = "sigma", resp = "n2oeq"),
      #prior(normal(0, 3), class = "Intercept", dpar = "shape", resp = "n2oeq"),
      
      prior(normal(0, 1), class = "sd", resp = "n2o"),
      prior(normal(0, 1), class = "sd", resp = "n2oeq"),
      prior(normal(0, 1), class = "sd", resp = "no3cat"),
      
      prior(normal(0, 1), class = "sd", dpar= "shape", resp = "n2o"),
      prior(normal(0, 1), class = "sd", dpar= "shape", resp = "n2oeq")
      ),
  control = list(adapt_delta = 0.90, max_treedepth = 12),
  #sample_prior = "only",
  save_pars = save_pars(all = TRUE),
  seed = 15224,
  chains=4, 
  iter=3000, 
  cores=4)

save(n2o_mod, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")
```

## Summarize fit
We call a summary of the fitted parameters.

```{r print_mod2, echo=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")

print(n2o_mod, prior = T)
```

## Model checks
Before we get too far with this model, we'll want to do extensive checking to ensure it is a reasonable approximation of the true data generating process.

```{r ppc_dens_overlay_mod_n2o, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.width=4, fig.height=4}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")
pp_check(n2o_mod, type = "dens_overlay", resp = "n2o", nsamples = 100, cores = 1) + 
  theme_tidybayes() + xlim(0, 50) + ggtitle(expression(paste("N"[2],"O")))#+ scale_x_continuous(trans = "log")

pp_check(n2o_mod, type = "dens_overlay", resp = "n2oeq", nsamples = 100, cores = 1) + 
  theme_tidybayes() + ggtitle(expression(paste("eqilibrium","N"[2],"O")))

pp_check(n2o_mod, type = "bars", resp = "no3cat", nsamples = 100, cores = 1) + 
  theme_tidybayes() +
  ggtitle(expression(paste("NO"[3], "\n category")))
```

## Leave-one-out evaluations
Next we'll conduct a Bayesian leave-one-out cross validation ('LOO-CV') assessment using the $\textbf{loo}$ package in $\textbf{R}$, which implements fast and stable computations for approximate LOO-CV (and WAIC) [@Vehtari_etal_2017]. These computation methods estimate pointwise, out-of-sample prediction accuracy from a fitted model by using the log-likelihood evaluated at the posterior simulations of the parameter values. Conveniently, the $\textbf{brms}$ package automatically calculates the log-likelihood for us for all relevant models, making it very simple to use in conjunction with the $\textbf{loo}$ package. For more information on $\textbf{loo}$ and LOO-CV in general, check out the page on the $\textbf{Stan}$ website: http://mc-stan.org/loo/.

### Calculate LOO-CV
```{r loo_overlay, echo=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")
pp_check(n2o_mod, "loo_pit_overlay", resp = "n2o", cores = 1)
pp_check(n2o_mod, "loo_pit_overlay", resp = "n2oeq", cores = 1)
```

The distribution of LOO-PIT values (thick black line) is not clearly a plausible draw from the uniform. Note the rise around 0.25 (x-axis) and dip around 0.6. The calibration looks like it is maybe slightly off, perhaps with a bias induced by compensation for extremes noted in the measured vs. predicted check. The checks below will investigate this potential mis-calibration further.

Next is a plot of the LOO marginal predictive distribution for each of the observations in the study, divided among the different methods and ordered by the median.

Clear pattern of mismatches between the observations ($y$) and the LOO prediction intervals ($y_{rep}$) and can indicate over-fitting, bias, under- or overdispersion, _etc._. The broad expectation is roughly even over- and under-prediction with roughly 50% of the observations falling outside the 50% intervals and 95% to outside the 95% intervals.
```{r obs_v_fitted, eval=FALSE, include=TRUE, fig.align='center', fig.height=5, fig.width=5}
load("full-analysis-files/n2o_mod.rda")

pp_check(n2o_mod, resp = "n2o", "scatter_avg", cores = 1)

pp_check(n2o_mod, resp = "n2oeq", "scatter_avg", cores = 1)
```


```{r loo_intervals, eval=FALSE, include=TRUE, fig.align='center', fig.height=20, fig.width=10}
load("full-analysis-files/n2o_mod.rda")

pp_check(n2o_mod, resp = "n2o", "loo_intervals", order = "median", prob = 0.5, prob_outer = 0.95, cores = 1) +
  facet_wrap( ~ df_model$WSA9, ncol = 1, scales = "free") + scale_y_continuous(trans = "log")

pp_check(n2o_mod, resp = "n2oeq", "loo_intervals", order = "median", prob = 0.5, prob_outer = 0.95, cores = 1) +
  facet_wrap( ~ df_model$WSA9, ncol = 1, scales = "free")
```

# Population estimates
Make a random sample from the population, proportional to the estimated cell sizes in the population. 
```{r psframe}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")

ID <- sample(1:536, # rows in pframe
                  10000, # size of the sample / any size could be used, depending on desired precision
                  prob = pframe$n_cell, # probability set proportional to cell size
                  replace = T)

psframe <- pframe[ID, 1:3] %>%
  print()

save(psframe, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/psframe.rda")
```

Next, we need to post-stratify the no3 predictions, in order to carry that uncertainty through and predict n2o.
```{r no3_predict_psframe}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/psframe.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")

predict_no3 <- psframe %>%
  add_predicted_draws(model = n2o_mod, resp="no3cat", allow_new_levels = TRUE, cores =1, n = 500) %>% # 500 draws reduce size
  mutate(no3_cat = .prediction) %>%
  print()

save(predict_no3, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/predict_no3.rda")
```


```{r loop_predictions}
predict_n2o <- predict_no3[,c(1:4, 7, 9)] %>%
  mutate(n2o_pred = 0,
         n2oeq_pred = 0)

predict_n2o$pr_grp <- rep(1:100, each = 50000)

system.time(
for(i in 1:max(predict_n2o$.draw)){
  predict_n2o[which(predict_n2o$pr_grp == i), 7:8] <- t(apply(posterior_predict(n2o_mod, newdata = predict_n2o[which(predict_n2o$pr_grp == i),], resp = c("n2o", "n2oeq"), allow_new_levels = T, nsamples = 500, cores = 1), 2, diag))
}
)
```

```{r loop_parallel_predict}
require(foreach)
require(itertools)

cl <- parallel::makeCluster(6) # set number of cores to use for emb. parallel predictions
doSNOW::registerDoSNOW(cl) # register the workers

predict_X <- predict_no3[,c(1:3, 11)] %>%
  ungroup()

predict_X$pr_grp <- as.integer(c(rep(1:2675, each = 87000), rep(2676, 223500)))

system.time(
preds <- foreach(i = 1:max(predict_X$pr_grp),
                 .combine = rbind,
                 .packages = c("brms")) %dopar% {
  t(apply(posterior_predict(n2o_mod, 
                            newdata = predict_X[which(predict_X$pr_grp == i),], 
                            resp = c("n2o", "n2oeq"), 
                            allow_new_levels = T, 
                            nsamples = 500, 
                            cores = 1),
          2, diag))
                 })

parallel::stopCluster(cl)

colnames(preds) <- c("preds_n2o", "preds_n2oeq")

save(preds, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/preds.rda")

predict_n2o <- predict_no3 %>% 
  ungroup() %>%
  cbind(preds) %>% 
  as_tibble() %>%
  mutate(preds_sat = preds_n2o / preds_n2oeq)

all_predictions <- predict_n2o[,c(1:6, 9, 11:14),] # remove unnecessary columns

save(all_predictions, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/all_predictions.rda")

rm(preds) # no longer needed
rm(predict_X)
rm(predict_no3)
rm(predict_n2o)
```

Lets first summarize at national level.
## National
### $N_2O$
#### Mean
```{r group_mean}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/all_predictions.rda")

all_predictions %>%
  group_by(WSA9, .draw) %>%
  summarise( mean_n2o = mean(preds_n2o)) %>%
  summarise( posterior_median = round(median(mean_n2o), 1),
    LCI = round(quantile(mean_n2o, probs = 0.025), 1),
    UCI = round(quantile(mean_n2o, probs = 0.975), 1))
```

```{r graph wsa9_n2o_estimates, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=8}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/all_predictions.rda")

all_predictions %>%
  group_by(WSA9, .draw) %>%
  #group_by(.draw) %>%
  summarise( mean_n2o = mean(preds_n2o)) %>%
  summarise( estimate = round(median(mean_n2o), 1),
    LCL = round(quantile(mean_n2o, probs = 0.025), 1),
    UCL = round(quantile(mean_n2o, probs = 0.975), 1)) %>% 
  mutate(ecoregion = factor(WSA9)) %>%
  mutate(type = "MR") %>%
  select(ecoregion, estimate, LCL, UCL, type) %>%
  mutate(ecoregion = fct_reorder(ecoregion, estimate)) %>%
  bind_rows(cbind(survey_ests[-10,], type = rep("survey", 9))) %>%
  ggplot( aes( x = ecoregion, y = estimate, group = type ) ) +
  geom_point( position=position_dodge(width=0.5) ) +
  geom_linerange( aes( ymin = LCL, ymax = UCL ) , position=position_dodge(width=0.5) ) +
  scale_colour_manual( values = c( "black", "grey" ) ) +
  #scale_y_continuous(limits = c(0.8, 2), breaks = seq(0.8, 2, 0.1)) +
  ylab("mean N2O concentration") +
  coord_flip() + 
  theme_bw()
```

```{r graph wsa9_sat_estimates, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=8}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/all_predictions.rda")

all_predictions %>%
  group_by(WSA9, .draw) %>%
  #group_by(.draw) %>%
  summarise( mean_sat = mean(preds_sat)) %>%
  summarise( estimate = round(median(mean_sat), 3),
    LCL = round(quantile(mean_sat, probs = 0.025), 3),
    UCL = round(quantile(mean_sat, probs = 0.975), 3)) %>% 
  mutate(ecoregion = factor(WSA9)) %>%
  #mutate(type = "MR") %>%
  select(ecoregion, estimate, LCL, UCL) %>%
  mutate(ecoregion = fct_reorder(ecoregion, estimate)) %>%
  #bind_rows(cbind(survey_ests, type = rep("survey", 10))) %>%
  ggplot( aes( x = ecoregion, y = estimate ) ) +
  geom_point( position=position_dodge(width=0.5) ) +
  geom_linerange( aes( ymin = LCL, ymax = UCL ) , position=position_dodge(width=0.5) ) +
  #geom_point(aes( x = ecoregion, y = sample_mean), shape = 8, color='red') +
  #scale_colour_manual( values = c( "black", "grey" ) ) +
  #scale_y_continuous(limits = c(0.8, 2), breaks = seq(0.8, 2, 0.1)) +
  geom_hline(yintercept = 1, color='blue') +
  ylab("mean N2O saturation ratio") +
  coord_flip() + 
  theme_bw()
```
```{r graph wsa9_prop_undersat, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=8}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/all_predictions.rda")

all_predictions %>%
  group_by(WSA9, .draw) %>%
  summarise(prop_sat = sum(preds_sat < 1) / length(unique(.row))) %>%
  summarise(estimate = round(median(prop_sat), 3),
    LCL = round(quantile(prop_sat, probs = 0.025), 3),
    UCL = round(quantile(prop_sat, probs = 0.975), 3)) %>% 
  mutate(ecoregion = factor(WSA9)) %>%
  select(ecoregion, estimate, LCL, UCL) %>%
  mutate(ecoregion = fct_reorder(ecoregion, estimate)) %>%
  ggplot( aes( x = ecoregion, y = estimate ) ) +
  geom_point( position=position_dodge(width=0.5) ) +
  geom_linerange( aes( ymin = LCL, ymax = UCL ) , position=position_dodge(width=0.5) ) +
  ylab("Proportion of waterbodies functioning as N2O sinks") +
  coord_flip() + 
  theme_bw()
```


```{r postrat_mean_n2o, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod2.rda")

posterior_mean <- posterior_epred(n2o_mod, 
                                  newdata = predict_no3, 
                                  resp = c("n2o", "n2oeq"),
                                  allow_new_levels = TRUE, 
                                  cores = 1,
                                  nsamples = 1000)

poststrat_mean_n2o <- (posterior_mean[,,1] %*% predict_no3$n_cell) / sum(predict_no3$n_cell) # div by nsims pstrat_no3
poststrat_mean_n2oeq <- (posterior_mean[,,2] %*% predict_no3$n_cell) / sum(predict_no3$n_cell)

popn_mean_summary_n2o <- c(posterior_median = median(poststrat_mean_n2o),
                           posterior_sd = sd(poststrat_mean_n2o), 
                           LCI = quantile(poststrat_mean_n2o, 0.025),
                           UCI = quantile(poststrat_mean_n2o, 0.975))

popn_mean_summary_n2oeq <- c(posterior_median = median(poststrat_mean_n2oeq),
                           posterior_sd = sd(poststrat_mean_n2oeq), 
                           LCI = quantile(poststrat_mean_n2oeq, 0.025),
                           UCI = quantile(poststrat_mean_n2oeq, 0.975))

save(posterior_mean, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/posterior_mean.rda")

save(poststrat_mean_n2o, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/poststrat_mean_n2o.rda")
save(poststrat_mean_n2oeq, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/poststrat_mean_n2oeq.rda")

round(popn_mean_summary_n2o, 2)
round(popn_mean_summary_n2oeq, 2)
```

Compare to sample means.

```{r sample_mean_n2o}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

round(mean(df_model$n2o), 2)
round(mean(df_model$n2o_eq), 2)
```

We can compare the n2o estimate to the survey estimate as well.
```{r survey_ests}
#make a dataframe object

survey_ests <- data.frame( 
  ecoregion = c( "CPL", "NAP", "NPL", "SAP", "SPL", "TPL", "UMW", "WMT", "XER", "US" ), 
  estimate = c( 8.4, 7.7, 6.9, 7.1, 6.5, 7.8, 10.8, 7.8, 10.6, 8.1 ),
  LCL = c( 5.1, 7.2, 6.4, 5.9, 4.9, 5.9, 6.4, 7.1, 7.5, 7.0 ),
  UCL = c( 11.7, 8.1, 7.4, 8.2, 8.1, 9.6, 15.2, 8.4, 13.7, 9.1 )
) %>%
  mutate( ecoregion = factor( ecoregion, 
                              levels = c( "CPL", "NAP", "NPL", "SAP", "SPL", "TPL", "UMW", "WMT", "XER", "US" ) ) ) #relevel for ggplot so not alphabetical, but original order

save(survey_ests, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/survey_ests.rda")

print( survey_ests[10,] )
```

## Saturation ratio
```{r postrat_mean_n2o_eq, message=FALSE}
posterior_mean_sat <- posterior_mean[,,1] / posterior_mean[,,2]

poststrat_mean_sat  <- (posterior_mean_sat %*% predict_no3$n_cell) / sum(predict_no3$n_cell)
popn_mean_summary_sat <- c(posterior_median = median(poststrat_mean_sat), 
                     posterior_sd = sd(poststrat_mean_sat), 
                     LCI = quantile(poststrat_mean_sat, 0.025), 
                     UCI = quantile(poststrat_mean_sat, 0.975))

round(popn_mean_summary_sat, 2)
```

We can compare that to the sample estimate.
```{r sample_mean_again}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")

round(mean(df_model$n2o / df_model$n2o_eq), 2)
```


#### Predictive distribution
```{r posterior_pr_n2o, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/predict_no3.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")

posterior_pr <- posterior_predict(n2o_mod, 
                                  newdata = predict_no3, 
                                  resp = c("n2o", "n2oeq"), 
                                  allow_new_levels = TRUE, 
                                  cores = 1,
                                  nsamples = 500)

save(posterior_pr, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/posterior_pr.rda")

#pp <- posterior_pr[,rbinom(536000, 1, prob = predict_no3$prop_cell*16) == 1]
```



```{r poststrat_nat_n2o}
poststrat_pr_n2o <- (posterior_pr[,,1] * predict_no3$n_cell) / (predict_no3$n_cell)
poststrat_pr_n2oeq <- (posterior_pr[,,2] * predict_no3$n_cell) / (predict_no3$n_cell)

popn_pr_summary_n2o <- c(posterior_mean = mean(poststrat_pr_n2o), 
                     posterior_sd = sd(poststrat_pr_n2o), 
                     LCI = quantile(poststrat_pr_n2o, 0.025), 
                     UCI = quantile(poststrat_pr_n2o, 0.975))

popn_pr_summary_n2oeq <- c(posterior_mean = mean(poststrat_pr_n2oeq), 
                     posterior_sd = sd(poststrat_pr_n2oeq), 
                     LCI = quantile(poststrat_pr_n2oeq, 0.025), 
                     UCI = quantile(poststrat_pr_n2oeq, 0.975))


save(poststrat_pr_n2o, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/poststrat_pr_n2o.rda")
save(poststrat_pr_n2oeq, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/poststrat_pr_n2oeq.rda")

round(popn_pr_summary_n2o, 2)
round(popn_pr_summary_n2oeq, 2)
```


### Predictive distribution
```{r postrat_pred_sat_ratio, message=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")

posterior_pr_n2o <- posterior_predict(n2o_mod, 
                                  newdata = pstrat_no3, 
                                  resp = "n2o",
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)

posterior_pr_n2oeq <- posterior_predict(n2o_mod, 
                                  newdata = pstrat_no3, 
                                  resp = "n2oeq",
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 3000)

posterior_pr_n2o <- exp(posterior_pr_n2o)
posterior_pr_n2o_eq <- exp(posterior_pr_n2oeq)

posterior_pr_sat <- posterior_pr_n2o / posterior_pr_n2o_eq

poststrat_pr_sat <- (posterior_pr_sat %*% pstrat_no3$prop_cell) / 1000 # div by nsims pstrat_no3 

model_popn_pref <- c(posterior_mean = mean(poststrat_pr_sat), 
                     posterior_sd = sd(poststrat_pr_sat), 
                     LCI = quantile(poststrat_pr_sat, 0.025), 
                     UCI = quantile(poststrat_pr_sat, 0.975))

save(poststrat_pr_sat, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/poststrat_pr_sat.rda")

round(model_popn_pref, 2)
```

# Ecoregion estimates
## Mean
We can also post-stratify and make estimates at the ecoregion level.
```{r poststrat_eco_estimates}
#load("C:/Users/rmartin/OneDrive - Environmental Protection Agency #(EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pstrat_no3.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")

eco_df <- data.frame(
  ecoregion = levels(as.factor(pstrat_no3$WSA9)),
  posterior_median = rep(-1, 9),
  sd = rep(-1, 9),
  LCI = rep(-1, 9),
  UCI = rep(-1, 9),
  sample_mean = rep(-1, 9),
  N = rep(-1, 9)
)

for(i in 1:length(levels(as.factor(pstrat_no3$WSA9)))) {
  poststrat_eco <- pstrat_no3[pstrat_no3$WSA9 == levels(as.factor(pstrat_no3$WSA9))[[i]], ]

  posterior_mu <- posterior_epred(n2o_mod, 
                                  newdata = poststrat_eco, 
                                  dpar = "mu", 
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)

  posterior_sigma <- posterior_epred(n2o_mod, 
                                  newdata = poststrat_eco, 
                                  resp = "logn2o", 
                                  dpar = "sigma", 
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)

  posterior_sigma_eq <- sample(posterior_samples(n2o_mod, resp = "logn2oeq")$sigma_logn2oeq, 1000, replace = FALSE)

  posterior_mean <- exp(posterior_mu[, , 1] + 0.5 * posterior_sigma ^ 2)

  posterior_mean_eq <- exp(posterior_mu[, , 2] + 0.5 * posterior_sigma_eq ^ 2)

  posterior_mean_sat <- posterior_mean / posterior_mean_eq

  poststrat_mean_sat <- (posterior_mean_sat %*% poststrat_eco$prop_cell) / 1000

  poststrat_prob_eco <- ((posterior_mean_sat %*% poststrat_eco$n_cell) / sum(poststrat_eco$n_cell))
  #This is the estimate for popn in ecoregion:
  eco_df$posterior_median[i] <- round(median(poststrat_prob_eco), 3)
  eco_df$sd[i] <- round(sd(poststrat_prob_eco), 3)
  eco_df$LCI[i] <- round(quantile(poststrat_prob_eco, 0.025), 3)
  eco_df$UCI[i] <- round(quantile(poststrat_prob_eco, 0.975), 3)
  #This is the estimate for sample
  eco_df$sample_mean[i] <- round(mean(df_model$n2o[df_model$WSA9 == levels(as.factor(pframe$WSA9))[[i]]] / 
                                        df_model$n2o_eq[df_model$WSA9 == levels(as.factor(pframe$WSA9))[[i]]]), 3)
  eco_df$N[i] <- length(df_model$n2o[df_model$WSA9 == levels(as.factor(pframe$WSA9))[[i]]])
}


save(eco_df, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/eco_sat_df.rda")

print(eco_df)
```
We can compare those to the survey estimates as well.
```{r survey_mean_again_eco}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/survey_ests.rda")

print(survey_ests[-10, ])
```
Lets do a graphical comparison at the ecoregion scale. We'll include the sample means as well (red asterisk).
```{r graph eco_estimates, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=8}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/eco_sat_df.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/survey_ests.rda")

eco_df %>%
  select(ecoregion, posterior_median, LCI, UCI, sample_mean) %>%
  rename(estimate = posterior_median,
         LCL = LCI,
         UCL = UCI) %>%
  mutate(ecoregion = factor(ecoregion)) %>%
  mutate(ecoregion = fct_reorder(ecoregion, estimate)) %>%
  ggplot( aes( x = ecoregion, y = estimate ) ) +
  geom_point( position=position_dodge(width=0.5) ) +
  geom_linerange( aes( ymin = LCL, ymax = UCL ) , position=position_dodge(width=0.5) ) +
  geom_point(aes( x = ecoregion, y = sample_mean), shape = 8, color='red') +
  scale_colour_manual( values = c( "black", "grey" ) ) +
  scale_y_continuous(limits = c(0.8, 2), breaks = seq(0.8, 2, 0.1)) +
  geom_hline(yintercept = 1, color='blue') +
  ylab("mean N2O saturation ratio") +
  coord_flip() + 
  theme_bw()
```
## Predictive distribution
We can also post-stratify and make estimates at the ecoregion level.
```{r poststrat_eco_estimates}
#load("C:/Users/rmartin/OneDrive - Environmental Protection Agency #(EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pstrat_no3.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/n2o_mod.rda")

eco_df <- data.frame(
  ecoregion = levels(as.factor(pstrat_no3$WSA9)),
  posterior_median = rep(-1, 9),
  sd = rep(-1, 9),
  LCI = rep(-1, 9),
  UCI = rep(-1, 9),
  sample_mean = rep(-1, 9),
  N = rep(-1, 9)
)

for(i in 1:length(levels(as.factor(pstrat_no3$WSA9)))) {
  poststrat_eco <- pstrat_no3[pstrat_no3$WSA9 == levels(as.factor(pstrat_no3$WSA9))[[i]], ]

  posterior_pr <- posterior_epred(n2o_mod, 
                                  newdata = poststrat_eco, 
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)
  
  posterior_pr_n2o <- exp(posterior_pr[,,1])

  posterior_pr_n2o_eq <- exp(posterior_pr[, , 2])

  posterior_pr_sat <- posterior_pr_n2o / posterior_pr_n2o_eq

  poststrat_pr_sat <- (posterior_pr_sat %*% poststrat_eco$prop_cell) / 1000

  #This is the estimate for popn in ecoregion:
  eco_df$posterior_median[i] <- round(median(poststrat_pr_sat), 3)
  eco_df$sd[i] <- round(sd(poststrat_pr_sat), 3)
  eco_df$LCI[i] <- round(quantile(poststrat_pr_sat, 0.025), 3)
  eco_df$UCI[i] <- round(quantile(poststrat_pr_sat, 0.975), 3)
  #This is the estimate for sample
  eco_df$sample_mean[i] <- round(mean(df_model$n2o[df_model$WSA9 == levels(as.factor(pframe$WSA9))[[i]]] / 
                                        df_model$n2o_eq[df_model$WSA9 == levels(as.factor(pframe$WSA9))[[i]]]), 3)
  eco_df$N[i] <- length(df_model$n2o[df_model$WSA9 == levels(as.factor(pframe$WSA9))[[i]]])
}


save(eco_df, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/eco_sat_pr_df.rda")

print(eco_df)
```


# State estimates
Lets post-stratify at the state level now.
```{r poststrat_state_estimates}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/mod.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")

state_df <- data.frame(
  state = levels(as.factor(df_model$state)),
  posterior_median = rep(-1, 48),
  sd = rep(-1, 48),
  LCI = rep(-1, 48),
  UCI = rep(-1, 48),
  sample_mean = rep(-1, 48),
  N = rep(-1, 48)
)

for(i in 1:length(levels(factor(df_model$state)))) {
  poststrat_state <- pstrat_no3[pstrat_no3$state == levels(factor(pstrat_no3$state))[[i]], ]
    posterior_mu <- posterior_epred(n2o_mod, 
                                  newdata = poststrat_state, 
                                  dpar = "mu", 
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)

  posterior_sigma <- posterior_epred(n2o_mod, 
                                  newdata = poststrat_state, 
                                  resp = "logn2o", 
                                  dpar = "sigma", 
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)

  posterior_sigma_eq <- sample(posterior_samples(n2o_mod, resp = "logn2oeq")$sigma_logn2oeq, 1000, replace = FALSE)

  posterior_mean <- exp(posterior_mu[, , 1] + 0.5 * posterior_sigma ^ 2)

  posterior_mean_eq <- exp(posterior_mu[, , 2] + 0.5 * posterior_sigma_eq ^ 2)

  posterior_mean_sat <- posterior_mean / posterior_mean_eq

  poststrat_mean_sat <- (posterior_mean_sat %*% poststrat_state$prop_cell) / 1000

  poststrat_prob_state <- ((posterior_mean_sat %*% poststrat_state$n_cell) / sum(poststrat_state$n_cell))
  
  #This is the estimate for popn in state:
  state_df$posterior_median[i] <- round(median(poststrat_prob_state), 2)
  state_df$sd[i] <- round(sd(poststrat_prob_state), 2)
  state_df$LCI[i] <- round(quantile(poststrat_prob_state, 0.025), 2)
  state_df$UCI[i] <- round(quantile(poststrat_prob_state, 0.975), 2)
  #This is the estimate for sample
  state_df$sample_mean[i] <- round(mean(df_model$n2o[df_model$state == levels(as.factor(df_model$state))[[i]]]), 2)
  state_df$N[i] <- length(df_model$n2o[df_model$state == levels(as.factor(df_model$state))[[i]]])
}

save(state_df, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/state_sat_df.rda")

print(state_df)
```

We don't yet have the survey design-based estimates for the state level, but lets plot the MRP state estimates (black) vs. the sample means (red asterisk).
```{r graph state_estimates, fig.align='center', fig.height=8, fig.width=8, warning=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/state_sat_df.rda")

state_df %>%
  mutate(state = factor(state)) %>%
  select(state, sample_mean, posterior_median, LCI, UCI) %>%
  rename(estimate = posterior_median,
         LCL = LCI,
         UCL = UCI,
         sample_mean = sample_mean) %>%
  mutate( state = fct_reorder( state, estimate)) %>%
  ggplot(aes(x = state, y = estimate)) +
  geom_point() +
  geom_point(aes( x = state, y = sample_mean), shape = 8, color='red') +
  geom_linerange(aes(ymin = LCL, ymax = UCL)) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 0.5)) +
  geom_hline(yintercept = 1, color='blue') +
  ylab("mean N2O saturation ratio") +
  coord_flip() +
  theme_tidybayes()
```

# Size category estimates
Finally, we'll look at the stream size level.
```{r poststrat_size_estimates}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/df_model.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/mod.rda")
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/pframe.rda")

size_df <- data.frame(
  size = levels(as.factor(df_model$size)),
  posterior_median = rep(-1, 5),
  sd = rep(-1, 5),
  LCI = rep(-1, 5),
  UCI = rep(-1, 5),
  sample_mean = rep(-1, 5),
  N = rep(-1, 5)
)

for(i in 1:length(levels(factor(df_model$size_cat)))) {
  poststrat_size <- pstrat_no3[pstrat_no3$size_cat == levels(factor(pstrat_no3$size_cat))[[i]], ]
    posterior_mu <- posterior_epred(n2o_mod, 
                                  newdata = poststrat_size, 
                                  dpar = "mu", 
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)

  posterior_sigma <- posterior_epred(n2o_mod, 
                                  newdata = poststrat_size, 
                                  resp = "logn2o", 
                                  dpar = "sigma", 
                                  allow_new_levels = TRUE, 
                                  cores = 1, 
                                  nsamples = 1000)

  posterior_sigma_eq <- sample(posterior_samples(n2o_mod, resp = "logn2oeq")$sigma_logn2oeq, 1000, replace = FALSE)

  posterior_mean <- exp(posterior_mu[, , 1] + 0.5 * posterior_sigma ^ 2)

  posterior_mean_eq <- exp(posterior_mu[, , 2] + 0.5 * posterior_sigma_eq ^ 2)

  posterior_mean_sat <- posterior_mean / posterior_mean_eq

  poststrat_mean_sat <- (posterior_mean_sat %*% poststrat_size$prop_cell) / 1000

  poststrat_prob_size <- ((posterior_mean_sat %*% poststrat_size$n_cell) / sum(poststrat_size$n_cell))
  #This is the estimate for popn in size:
  size_df$posterior_median[i] <- round(median(poststrat_prob_size), 2)
  size_df$sd[i] <- round(sd(poststrat_prob_size), 2)
  size_df$LCI[i] <- round(quantile(poststrat_prob_size, 0.025), 2)
  size_df$UCI[i] <- round(quantile(poststrat_prob_size, 0.975), 2)
  #This is the estimate for sample
  size_df$sample_mean[i] <- round(mean(df_model$n2o[df_model$size_cat == levels(as.factor(df_model$size_cat))[[i]]] / 
                                         df_model$n2o_eq[df_model$size_cat == levels(as.factor(df_model$size_cat))[[i]]]), 2)
  size_df$N[i] <- length(df_model$n2o[df_model$size_cat == levels(as.factor(df_model$size_cat))[[i]]])
}

save(size_df, file = "C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/size_sat_df.rda")

print(size_df)
```

And plot them.
```{r graph size_estimates, fig.align='center', fig.height=4, fig.width=6, warning=FALSE}
load("C:/Users/rmartin/OneDrive - Environmental Protection Agency (EPA)/Documents/AE_Reservoirs/DissolvedGasNla/modelFiles/size_sat_df.rda")

size_df %>%
  mutate(size = factor(size)) %>%
  select(size, sample_mean, posterior_median, LCI, UCI) %>%
  rename(estimate = posterior_median,
         LCL = LCI,
         UCL = UCI) %>%
  mutate(size = fct_reorder( size, estimate)) %>%
  ggplot(aes(x = size, y = estimate)) +
  geom_point() +
  geom_point(aes( x = size, y = sample_mean), shape = 8, color='red')+
  geom_linerange(aes(ymin = LCL, ymax = UCL)) +
  geom_hline(yintercept = 1, color='blue') +
  ylab("mean N2O saturation ratio") +
  coord_flip() +
  theme_tidybayes()
```

# References
