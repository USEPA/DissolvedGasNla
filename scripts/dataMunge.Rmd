---
title: "Data Munging"
authors: "J. Beaulieu, R. Martin, and M. McManus"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: yes
    depth: 2
    number_sections: true
editor_options: 
  chunk_output_type: console
---
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
# load libraries
library(tidyverse) # dplyr, ggplot

# Identify local path for each user
localPath <- Sys.getenv("USERPROFILE")
```


# Purpose
The purpose of this .rmd is to prepare the data set for subsequent modeling.  The data will be written as .RData object and stored at the shared documents library associated with this project: https://usepa.sharepoint.com/sites/ORD_NLA17_Dissolved_Gas

The dissolved gas data were currated in the 'NLA' dissolved gas project in RStudio.  The code can be found at a private github repository (https://github.com/USEPA/NLA).  After aggregating across duplicate samples, the data were written to nla17gasDataAggregated_2019-11-12.txt.  A copy of this data file is stored in documents library associated with the 'ORD NLA17 Dissolved Gas' Private Group on SharePoint (https://usepa.sharepoint.com/sites/ORD_NLA17_Dissolved_Gas).  When synced to a local computer, the documents library can be read directly with R, after identifying the local directory path.

Below we read in the .txt file, perform a few manipulations, then write out a .Rdata object.

```{r}
# Read data file
dg <- read.table(file = paste0(localPath, 
                               "/Environmental Protection Agency (EPA)/",
                               "ORD NLA17 Dissolved Gas - Documents/",
                               "inputData/nla17gasDataAggregated_2019-11-12.txt"),
                 header = TRUE, sep = "\t", as.is = TRUE) %>%
  # unit conversion
  mutate(dissolved.ch4 = dissolved.ch4 * 1000000, # mol/L -> umol/L
         dissolved.co2 = dissolved.co2 * 1000000, # mol/L -> umol/L,
         dissolved.n2o = dissolved.n2o * 1000000000, # mol/L -> nmol/L
         # add source/sink column
         co2.src.snk = ifelse(co2.sat.ratio > 1, "source", "sink"),
         ch4.src.snk = ifelse(ch4.sat.ratio > 1, "source", "sink"),
         n2o.src.snk = ifelse(n2o.sat.ratio > 1, "source", "sink"))
```

The survey design is stratified by State.  Within each state, an unequal probability category based on 5 lake size classes is used.  As of 12/12/2019, NLA has not provided data on waterbody size.  Size was estimated by doing a spatial overlay of the waterbody lat/lon with NHDPlusV2.  Surface area (AREASQKM) was then extracted from NHDPlusV2.  The data currently contains `r dg %>% as.data.frame() %>% filter(is.na(AREASQKM)) %>% {nrow(.)}` missing waterbody size values.  For now, we'll use these data to add the size categories to the data file.
```{r}
dg <- dg %>%
  mutate(
    # add state
    state = substr(site.id, 7, 8),
    AREA_HA = AREASQKM / 100, # 100Ha in 1 km2 
    size_cat = ifelse(AREA_HA <= 4,
                      "LE4",
                      ifelse(AREA_HA > 4 & AREA_HA <= 10,
                             "G4_LE10",
                             ifelse(AREA_HA > 10 & AREA_HA <= 20,
                                    "G10_LE20",
                                    ifelse(AREA_HA > 20 & AREA_HA <= 50,
                                           "G20_LE50",
                                           ifelse(AREA_HA > 50,
                                                  "G50",
                                                  NA))))))

```


Concentrations of CO~2~, CH~4~, and N~2~O in ambient air over the waterbodies were measured and used to calculate the equilibrium dissolved gas concentration (variables sat.co2, sat.ch4, and sat.n2o).  These data are not needed in subsequent analysis and will be removed from the dataframe.
```{r}
dg <- dg %>% filter(sample.source == "DG") # select dissolved gas 'DG' samples
```

The dataframe also contains observations from site in Alaska.  These sites were not an official part of the NLA and will not be included in this analysis.
```{r}
dg <- dg %>% filter(!(grepl("AK", site.id))) # exlclude alaska
```


Write out final .RData object.
```{r}
save(dg, file = paste0(localPath, 
                       "/Environmental Protection Agency (EPA)/",
                       "ORD NLA17 Dissolved Gas - Documents/",
                       "inputData/dg.RData"))
```



